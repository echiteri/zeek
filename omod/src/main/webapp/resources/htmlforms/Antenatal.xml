<htmlform formName="Antenatal Form"
		  formDescription="A visit for a mother for ANC services"
		  formEncounterType="2549af50-75c8-4aeb-87ca-4bb2cef6c69a"
		  formUuid="12de5bc5-352e-4faf-9961-a2125085a75c"
		  formVersion="0.9"
		  formAddMetadata="yes"
		  formUILocation="patientDashboard.overallActions"
		  formOrder="1"
		  formIcon="icon-medkit"
		  formShowIf="patient.person.dead==false &amp;&amp; patient.person.gender=='F' &amp;&amp; patient.person.age &gt; 12"
		  formDisplayStyle="Standard">
	<script>
		jq(function() {
			<!-- Set the id value of the followup container from the class since the section tag does not have an id attribute-->
			jq('.followup-container').attr('id', 'followup-container');
		
			<!-- Show the current location and visit date while hiding the encounter location drop down and date picker for
			encounter date -->
			jq('#encounterLocation').hide();
			jq('#currentLocation').text(jq('#encounterLocation select option:selected').text());
		<ifMode mode="ENTER">
			<!-- the encounter date should be empty on a new form -->
			setValue('encounterDate.value', '');
			<!-- By default hide containers -->
			hideContainer('#pregnancy-detail-container');
			<!-- hideContainer('#hiv-test-container'); -->
			hideContainer('#hiv-test-result-container');
			hideContainer('#art-initiation-container');
			hideContainer('#art-number-container');
			hideContainer('#refused-art-container');
			hideContainer('#art-startdate-container');
			hideContainer('#recent-viral-load-container');
			hideContainer('#viral-load-test-date-container');
			hideContainer('#viral-load-results-container');
			hideContainer('#viral-load-copies-container');
			<!-- hideContainer('#transfer-out-container'); -->
			hideContainer('#transfer-out-to-container');
			hideContainer('#transfer-out-date-container');
			<!-- Don't show HIV testing if HIV test status = previously known positive, or HIV test result = tested positive -->
			if("<lookup complexExpression="$fn.latestObs('159427AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId"/>" == '138571'
				|| "<lookup complexExpression="$fn.latestObs('164401AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId"/>" == '164911')
			{
				hideContainer('#hiv-test-container');
			}
			<!-- Don't show ART initiation if ART initiation date exists -->
			if(!"<lookup complexExpression="$fn.latestObs('159599AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').obsDatetime"/>")
			{
				hideContainer('#art-initiation-container');
			}
		</ifMode>
		<ifMode mode="EDIT">
			<!-- Check to restrict encounter editing to only latest encounters -->
			var latestEncounterDate = new Date("<lookup complexExpression="$fn.latestEncounter('2549af50-75c8-4aeb-87ca-4bb2cef6c69a').encounterDatetime"/>");
			var currentVisitDate = new Date("<lookup expression="visit.startDatetime"/>");
			if (currentVisitDate &lt; latestEncounterDate) {
				jq().toastmessage('showToast',{
					text : 'This is not the latest Encounter. You can only Edit the latest encounter. \n\n You will now be taken back to the patient dashboard.',
					stayTime: 5000,
					type: 'error'
					}
				);
				setTimeout(function(){
					window.location.href = window.location.protocol + &quot;//&quot; + window.location.host + &quot;/&quot;+ OPENMRS_CONTEXT_PATH +
					&quot;/coreapps/clinicianfacing/patient.page?patientId=<lookup complexExpression="$fn.latestEncounter('2549af50-75c8-4aeb-87ca-4bb2cef6c69a').patient.patientId"/>&quot;;
				},
				5000);
			}
		</ifMode>
		<ifMode mode="ENTER" include="FALSE">
			<!-- Hide pregnancy detail  it is not the client's first ANC -->
			if("<lookup expression="fn.getObs($encounter, '164181').valueCoded.conceptId"/>" == '160530')
			{
				hideContainer('#pregnancy-detail-container');
			}
			<!-- Disable editing of PTracker ID -->
			if("<lookup expression="fn.getObs($encounter, '164951')"/>" != '')
			{
            <!-- hideContainer('#ptrackerid-container-input');-->
                disableContainer('#ptrackerid-container-input'); <!-- Dispable to avoid validating a hidden field -->
                setValue('ptrackerid.error', '');
                getField('ptrackerid.error').html('The PTracker ID is not editable. Contact System Administrator to assist.').show();
			}
			<!-- Hide Gravida if it was not captured in this encounter -->
			if("<lookup expression="fn.getObs($encounter, '5624')"/>" == '')
			{
				hideContainer('#gravida-container-label');
				hideContainer('#gravida-container-input');
			}
			<!-- Hide Para if it was not captured in this encounter -->
			if("<lookup expression="fn.getObs($encounter, '1053')"/>" == '')
			{
				hideContainer('#para-container-label');
				hideContainer('#para-container-input');
			}
			<!-- Hide LMP if it was not captured in this encounter -->
			if("<lookup expression="fn.getObs($encounter, '1427')"/>" == '')
			{
				hideContainer('#lmp-container-label');
				hideContainer('#lmp-container-input');
			}
			<!-- Hide EDD if it was not captured in this encounter -->
			if("<lookup expression="fn.getObs($encounter, '5596')"/>" == '')
			{
				hideContainer('#edd-container-label');
				hideContainer('#edd-container-input');
			}
			<!-- Hide HIV Test Status if it was not captured in this encounter -->
			if("<lookup expression="fn.getObs($encounter, '164401')"/>" == '')
			{
				hideContainer('#hiv-test-container');
			}
			<!-- Hide HIV Test Status if it was not captured in this encounter -->
			if("<lookup expression="fn.getObs($encounter, '164401')"/>" == '')
			{
				hideContainer('#hiv-test-container');
			}
			<!-- Hide HIV Test results if it was not captured in this encounter -->
			if("<lookup expression="fn.getObs($encounter, '159427')"/>" == '')
			{
				hideContainer('#hiv-test-result-container');
			}
			<!-- Hide ART Initiation if it was not captured in this encounter -->
			if("<lookup expression="fn.getObs($encounter, '164915')"/>" == '')
			{
				hideContainer('#art-initiation-container');
			}
			<!-- Hide ART number if it was not captured in this encounter -->
			if("<lookup expression="patient.getPatientIdentifier('ART Unique Number')"/>" == '')
			{
				hideContainer('#art-number-container');
			}
			<!-- Hide Reason for ART Refusal if it was not captured in this encounter -->
			if("<lookup expression="fn.getObs($encounter, '163322')"/>" == '')
			{
				hideContainer('#refused-art-container');
			}
			<!-- Hide ART Start Date if it was not captured in this encounter -->
			if("<lookup expression="fn.getObs($encounter, '159599')"/>" == '')
			{
				hideContainer('#art-startdate-container');
			}
			<!-- Hide Recent Viral load status if it was not captured in this encounter -->
			if("<lookup expression="fn.getObs($encounter, '163310')"/>" == '')
			{
				hideContainer('#recent-viral-load-container');
			}
			<!-- Hide Recent Viral load test date if it was not captured in this encounter -->
			if("<lookup expression="fn.getObs($encounter, '163281')"/>" == '')
			{
				hideContainer('#viral-load-test-date-container');
			}
			<!-- Hide Recent Viral load results if it was not captured in this encounter -->
			if("<lookup expression="fn.getObs($encounter, '1305')"/>" == '')
			{
				hideContainer('#viral-load-results-container');
			}
			<!-- Hide Viral load copies if it was not captured in this encounter -->
			if("<lookup expression="fn.getObs($encounter, '856')"/>" == '')
			{
				hideContainer('#viral-load-copies-container');
			}
			<!-- Hide Next visit date if it was not captured in this encounter
			if("<lookup expression="fn.getObs($encounter, '5096')"/>" == '')
			{
				hideContainer('#next-visit-date-container');
			}-->
			<!-- Hide Transfer out to if it was not captured in this encounter -->
			if("<lookup expression="fn.getObs($encounter, '159495')"/>" == '')
			{
				hideContainer('#transfer-out-to-container');
			}
			<!-- Hide Transfer out date if it was not captured in this encounter -->
			if("<lookup expression="fn.getObs($encounter, '160649')"/>" == '')
			{
				hideContainer('#transfer-out-date-container');
			}

		</ifMode>
			
		
			<!-- EDD computation -->
			jq('#lmp :input[type=text]').change(function(){
				setValue('edd.value', calculateEDD(getValue('lmp.value')));
			});
		
			beforeSubmit.push(function() {
				<!-- validation rules for Pregancy information -->
				<!-- Validate pregnancy details -->

				<!-- if there is a a first visit the pregnancy information is required -->
				var regex_ptrackerid = /^[0-9]{5}[A-Z]{1}[0-9]{6}$$/; <!-- ID format: 12345A170001 Mother  -->
				setValue('ptrackerid.error', '');
				<!-- Check if the PTracker ID meets the Regex -->
				if($('#ptrackerid-container-input').is(':visible')){<!-- only validate if not hidden -->
					if(!regex_ptrackerid.test(getValue('ptrackerid.value'))){
						getField('ptrackerid.error').html('PTracker ID format is wrong.').show();
						isValid = false;
					}
				}
				if (getValue('antenatal-visit-type.value') == 164180) {
					setValue('gravida.error', '');
					setValue('para.error', '');
					setValue('lmp.error', '');
					setValue('edd.error', '');

					<!-- Validate PTracker ID provision -->
					if (!getValue('ptrackerid.value')) {
						getField('ptrackerid.error').html('PTracker ID must be provided').show();
						return false;
					}

					if (!getField('gravida.value').is(':disabled') &amp;&amp; !getValue('gravida.value')) {
						getField('gravida.error').html('Gravida must be provided').show();
						return false;
					}
					if (!getField('para.value').is(':disabled') &amp;&amp; !getValue('para.value')) {
						getField('para.error').html('Para must be provided').show();
						return false;
					}
					if (!getField('lmp.value').is(':disabled') &amp;&amp; !getValue('lmp.value')) {
						getField('lmp.error').html('LMP must be provided').show();
						return false;
					}
					if (!getField('edd.value').is(':disabled') &amp;&amp; !getValue('edd.value')) {
						getField('edd.error').html('Edd must be provided').show();
						return false;
					}
				} else if (getValue('antenatal-visit-type.value') == 160530 &amp;&amp; $('#ptrackerid_readonly').text().trim() == "PTracker ID is Missing") {
					<!-- Validate PTracker ID provision -->
					if (!getValue('ptrackerid.value')) {
						getField('ptrackerid.error').html('PTracker ID must be provided').show();
						return false;
					}
				}

				if (getField('lmp.value') != null) {
					<!-- LNMP must be before the encounter date -->
					var lmpDate = new Date(changeFieldDateToJavascriptDate(getValue('lmp.value')));
					var encounterDate = new Date(changeFieldDateToJavascriptDate(getValue('encounterDate.value')));
					if (Date.parse(lmpDate)) {
						if (encounterDate &lt; lmpDate) {
							getField('lmp.error').html('The date of the last menstral period must be before the visit date ' +
			changeFieldDateToJavascriptDate(getValue('encounterDate.value'))).show();
							return false;
						}

						<!-- The LMP date cannot be more than 44 weeks before the visit date for ANC -->
						if (Math.abs(encounterDate - lmpDate)/(1000 * 86400 * 7) > 43) {
							getField('lmp.error').html('The date of the last menstral period cannot be more than 44 weeks before the visit date ' + changeFieldDateToJavascriptDate(getValue('encounterDate.value'))).show();
							return false;
						}
					}
				}
				
				if (getField('edd.value') != null) {
					var lmpDate = new Date(changeFieldDateToJavascriptDate(getValue('lmp.value')));
					var eddDate = new Date(changeFieldDateToJavascriptDate(getValue('edd.value')));

					<!-- The EDD date cannot be more than 12 Months after the LNMP date for ANC -->
					if (Math.abs(eddDate - lmpDate)/(1000 * 86400 * 30.4) > 10) {
						getField('edd.error').html('The EDD cannot be more than 10 months after LNMP ' + changeFieldDateToJavascriptDate(getValue('encounterDate.value'))).show();
						return false;
					}
				}

				<!-- Validate ANC followup question -->
				if ($('#antenatal-visit-type').length > 0) {
					setValue('antenatal-visit-type.error', '');

					if (!getValue('antenatal-visit-type.value')) {
						getField('antenatal-visit-type.error').html('The ANC followup question must be answered').show();
						return false;
					}
				}
		
				<!-- Validation rules for Testing and Initiation -->
				<!-- clear the previous errors -->
				<!-- Validate HIV test done -->
				if (!jq('#hiv-test-container').hasClass('hidden')) { <!-- check the existence of the element and doesn't have a class hidden -->
					setValue('hiv-test.error', '');
						if (!getField('hiv-test.value').is(':disabled') &amp;&amp;!getValue('hiv-test.value')) {
							getField('hiv-test.error').html('HIV test must be provided').show();
							return false;
						}
				}

				<!-- Validate HIV test result -->
				if (!jq('#hiv-test-result-container').hasClass('hidden')) { <!-- check the existence of the element and doesn't have a class hidden -->
					setValue('hiv-test-result.error', '');

					<!-- if there is a test the test result is required -->
					if (getValue('hiv-test.value') == 164912) {
							if (!getValue('hiv-test-result.value')) {
								getField('hiv-test-result.error').html('The results for the HIV test must be provided').show();
								return false;
							}
					}
				}

				<!-- Validate ART Initiation -->
				if (!jq('#art-initiation-container').hasClass('hidden')) { <!-- check the existence of the element and doesn't have a class hidden -->
					setValue('art-initiation.error', '');
					<!-- the art initiation is required  if Test status is done and results is P, or KP -->
					if ($('#hiv-test').length > 0 &amp;&amp; $('#hiv-test-result').length > 0)
					{
						if (((getValue('hiv-test.value') == 164912 &amp;&amp; getValue('hiv-test-result.value')  == 138571) || getValue('hiv-test.value') == 164911)) {
							if (!getValue('art-initiation.value')) {
								getField('art-initiation.error').html('ART initiation status must be provided').show();
								return false;
							}
						}
					} else {
						if (!getValue('art-initiation.value')) {
							getField('art-initiation.error').html('ART initiation status must be provided').show();
							return false;
						}
					}
				}
				<!-- Validate recent viral load done-->
				if (!jq('#recent-viral-load-container').hasClass('hidden')) { <!-- check the existence of the element and doesn't have a class hidden -->
					setValue('recent-viral-load.error', '');
					<!-- the recent-viral-load is required if Test status is KP -->
					if ($('#hiv-test').length > 0)
					{
						if (getValue('hiv-test.value') == 164911){
							if (!getValue('recent-viral-load.value')) {
								getField('recent-viral-load.error').html('Recent viral load must be provided').show();
								return false;
							}
						}
					}else {
						if (!getValue('recent-viral-load.value')) {
							getField('recent-viral-load.error').html('Recent viral load must be provided').show();
							return false;
						}
					}
				}

				<!-- Validate viral load results -->
				if (!jq('#viral-load-results-container').hasClass('hidden')) { <!-- check the existence of the element and doesn't have a class hidden -->
					setValue('viral-load-results.error', '');
					<!-- the viral-load-results is required  -->
					if (getValue('recent-viral-load.value') == 1065){
						if (!getValue('viral-load-results.value')) {
							getField('viral-load-results.error').html('Viral load results must be provided').show();
							return false;
						}
					}
				}
		
				<!-- Validation rules for follow up -->
				setValue('transfer-out-to.error', '');
				setValue('transfer-out.error', '');
				setValue('next_visit_date.error', '');
				<!-- check the date of the next visit -->
				var next_visit_date = new Date(changeFieldDateToJavascriptDate(getValue('next_visit_date.value')));
				<!-- next visit date must be after the current visit date -->
				if (encounterDate &gt; next_visit_date) {
					getField('next_visit_date.error').html('The date of the next visit ' + 'must be after ' + changeFieldDateToJavascriptDate(getValue('encounterDate.value')) + ' the date of this visit').show();
					return false;
				}
			
				<!-- also check that the next visit is not after the expected date of delivery -->

				var edd = new Date(getValue('edd.value'));
				if (Date.parse(edd)) { <!-- For followup ANC visit, the edd will be empty, check to avoid 'invalid argument' js exception -->
					if (next_visit_date &gt; edd) {
						getField('next_visit_date.error').html('The date of the next visit cannot be after the expected delivery date of ' + changeFieldDateToJavascriptDate(getValue('edd.value'))).show();
						return false;
					}
				}

		
				if (!jq('#transfer-out-to-container').hasClass('hidden')) {
					<!-- the transfer  out location is required -->
					if (getValue('transfer-out-to.value') == '') {
						getField('transfer-out-to.error').html('Please enter the facility to which the patient is to transfer to').show();
						return false;
					}
				}
				if (!jq('#transfer-out-container').hasClass('hidden')) {
					<!-- the transfer  out is required -->
					if (getValue('transfer-out.value') == '') {
						getField('transfer-out.error').html('Please enter the facility of next appointment').show();
						return false;
					}
				}
		
				return true;
			});
		});
		
		<!--Function to calculate EDD-->
		function calculateEDD(lmp){
			if (!lmp.trim()) {
				return "";
			}
			
			<!--Based on (((lmp + 1 year)-3 months) + 7 days) algorithm-->
			var lmpDate = new Date(lmp);
			lmpDate.setYear(lmpDate.getFullYear() + 1);
			lmpDate.setMonth(lmpDate.getMonth() - 3);
			lmpDate.setDate(lmpDate.getDate() + 7);
			var mm = lmpDate.getMonth() + 1;
			var dd = lmpDate.getDate();
			var yyyy = lmpDate.getFullYear();
			mm = (mm &lt; 10) ? '0' + mm : mm;
			dd = (dd &lt; 10) ? '0' + dd : dd;
			
			var date = yyyy + '-' + mm + '-' + dd;
			return date;
		}
		<!-- change display date format to namibia locale -->
		function changeDisplayDateFormat(rawDate)
		{
			var monthShort = ["Jan", "Feb", "Mar", "Apr", "May", "Jun",
			"Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
			];
			var d = new Date(rawDate);
			var mm = monthShort[d.getMonth()-1]; <!-- minus 1 due to list positioning -->
			var dd = d.getDate();
			var yyyy = d.getFullYear();
			mm = (mm &lt; 10) ? '0' + mm : mm;
			dd = (dd &lt; 10) ? '0' + dd : dd;
			var formattedDate = dd + '/' + mm + '/' + yyyy;
			return formattedDate;
		}
	</script>
	
	<h2>
		<label>
			Antenatal Form
		</label>
	</h2>
	<postSubmissionAction class="org.openmrs.module.namibia.htmlformentry.MCHProgramManagementPostSubmissionAction"/>
	<table id="who-when-where">
		<tbody>
			<tr>
				<td>
					<label>
						Attending Clinican
					</label>
					<encounterProvider default="currentUser" />
				</td>
				<td>
					<label>
						Health Facility
					</label>
					<span id="currentLocation"></span>
					<encounterLocation default="SessionAttribute:emrContext.sessionLocationId"
									   tags="1" /> <!-- Only show Login locations -->
				</td>
				<td>
					<label name="encounterDate">
						Visit Date
					</label>
					<encounterDate disallowMultipleEncountersOnDate="block" />
				</td>
				<!-- <td><label>PTracker Pregnancy Number</label><obs conceptId="161655AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" /></td> -->
			</tr>
		</tbody>
	</table>

	<includeIf velocityTest="$fn.allEncounters('2549af50-75c8-4aeb-87ca-4bb2cef6c69a').size() > 0">
		<!-- Subsequent ANC visit -->
		<!-- TODO: Need to find a way of checking that this encounter is after the EDD so that multiple pregancies are handled -->
		<section sectionTag="fieldset" headerTag="legend" headerStyle="title summary" headerCode="First ANC Visit Summary Information">
			<script>
				jq(function() {
					<!-- change the label of the legend for this section since its nolonger the first ANC visit -->
					jq('legend.summary').html('ANC Visit Summary Information');
					<!-- Show the EDD -->
					<!-- There is not LMP date yet. Is there need to show the EDD? Throws a js error!!!
					var eddDate =  changeDisplayDateFormat(calculateEDD(jq('#lmp').text()));
					jq('#edd').text(eddDate);-->
				});
			</script>
			<div class="section-container">
				<table>
					<tr>
						<th align="left">Age (Years)</th>
						<th colspan="2" align="left" width="60%">Telephone Number</th>
					</tr>
					<tr>
						<td><lookup expression="patient.age"/></td>
						<td colspan="2" width="60%"><lookup expression="personAttributes.get('Telephone Number')"/></td>
					</tr>
						<tr>
							<th align="left" width="40%">Date of Last Known Menstral Period (LNMP)</th>
							<th align="left" width="30%">Expected Date of Delivery (EDD)</th>
							<th align="left">Date of last HIV Test</th>
						</tr>
						<tr>
							<td><span id="lmp"><lookup expression="fn.latestObs('1427AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueDatetime" /></span></td>
							<td><span id="edd"><lookup expression="fn.latestObs('5596AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueDatetime" /></span></td>
							<td>
								<includeIf velocityTest="$fn.latestObs('159427AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA')">
									<lookup	complexExpression="$fn.latestObs('159427AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').obsDatetime"/>
								</includeIf>
							</td>
						
						</tr>
						
						<!-- <includeIf velocityTest="$fn.latestObs('164401AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 1065"> [this prevents this section from showing]-->
							<!-- todo: Show HIV and ART status if the encounter facility is similar to patient last encounter facility-->
							<!-- <tr>
								<th align="left">Last HIV Status</th>
								<th align="left">Date of last HIV Test</th>
								<th>ART Initiation Status </th>
							</tr>
							<tr>
								<td>
									 <includeIf velocityTest="$fn.latestObs('1396AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA')">
										<lookup	complexExpression="$fn.latestObs('1396AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.name"/>
									</includeIf>
								</td>
								<td>
									<includeIf velocityTest="$fn.latestObs('1396AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA')">
										<lookup	complexExpression="$fn.latestObs('1396AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').obsDatetime"/>
									</includeIf>
								</td>
								<td>
									<includeIf velocityTest="$fn.latestObs('160117AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA')">
										<lookup	complexExpression="$fn.latestObs('160117AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.name"/>
									</includeIf>
									<includeIf velocityTest="$fn.latestObs('159599AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA')">
										Since <lookup	complexExpression="$fn.latestObs('159599AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').obsDatetime"/>
									</includeIf>
								</td>
							</tr> todo: above ends here-->
						<!-- </includeIf> -->
						<includeIf velocityTest="($fn.latestObs('164401AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 164913)
												|| $fn.latestObs('	164401AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 1067 ">
							<tr>
								<th align="left">Last HIV Status</th>
								<th colspan="2" align="left">Reason for Not Testing
								</th>
							</tr>
							<tr>
								<td>Not Tested</td>
								<td colspan="2">
									<includeIf velocityTest="$fn.latestObs('164401AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 164911">
										Previously known positive
									
									</includeIf>
									<includeIf velocityTest="$fn.latestObs('164401AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 1067">
										Unknown <!-- added for unknown -->
									</includeIf>

								</td>
							</tr>
						</includeIf>
					<!-- disabled the display below because it is currently based on "Reason for not testing" which has been merged with
						"HIV test status" above. Until tested and confirm, consider restoring the section below. -->
					<!-- <includeIf velocityTest="($fn.latestObs('164401AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 1066)
												|| $fn.latestObs('164401AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 1067 "> added for unknown
							<tr>
								<th align="left">Last HIV Status</th>
								<th colspan="2" align="left">Reason for Not Testing
								</th>
							</tr>
							<tr>
								<td>Not Tested</td>
								<td colspan="2">
									<includeIf velocityTest="$fn.latestObs('159803AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 1169">
										Previously known positive

									</includeIf>
									<includeIf velocityTest="$fn.latestObs('159803AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 160352">
										Testing kit stockout

									</includeIf>
									<includeIf velocityTest="$fn.latestObs('159803AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 128453">
										Refused Test : <lookup	complexExpression="#set($refuse_reason = $fn.latestObs('160632AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueText) $!{refuse_reason}" />

									</includeIf>
									<includeIf velocityTest="$fn.latestObs('159803AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 1067">
										Unknown -:added for unknown
									</includeIf>

								</td>
							</tr>
						</includeIf>-->
						<tr>
							<th align="left" width="40%">Previous ANC Visits</th>
							<th align="left" width="30%">Last ANC Clinic</th>
							<th align="left">Last ANC Provider</th>
						</tr>
						<tr>
							<td><lookup	complexExpression="$fn.allEncounters('2549af50-75c8-4aeb-87ca-4bb2cef6c69a').size()"/></td>
							<td><lookup	complexExpression="$fn.latestEncounter('2549af50-75c8-4aeb-87ca-4bb2cef6c69a').location.name" /></td>
							<td>
								
							</td>
						</tr>
					</table>
			</div>
		</section>
		
	</includeIf>
	<section sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="ANC visit type">
		<div class="section-container">
			<p id="antenatal-visit-type-container">
				<label>Is this your first antenatal visit</label>
				<obs id="antenatal-visit-type" conceptId="164181AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerConceptIds="164180,160530" answerLabels="Yes,No" style="radio" answerSeparator="" />
				<script>
					jq(function() {
						<!-- requires capturing of PTracker ID -->
						<!-- jq('#ptrackerid-container-display').hide(); -->
						<!-- -->
						jq('#antenatal-visit-type').click(function(){
							if (getValue('antenatal-visit-type.value') == 164180){
								showContainer('#pregnancy-detail-container'); <!-- Show pregnancy detail container -->
								showContainer('#ptrackerid-container'); <!-- show the entire container -->
								showContainer('#ptrackerid-container-input');
								hideContainer('#ptrackerid-container-display');
							} else if (getValue('antenatal-visit-type.value') == 160530) {
								hideContainer('#pregnancy-detail-container'); <!-- Hide pregnancy detail container -->
								showContainer('#ptrackerid-container');  <!-- Show container to display the Read Only PTracker ID -->
								if($('#ptrackerid_readonly').text().trim() == "PTracker ID is Missing"){
									showContainer('#ptrackerid-container-display');
									showContainer('#ptrackerid-container-input');
									enableContainer('#ptrackerid-container-input'); <!-- Dispable to avoid validating a hidden field -->
									$("#ptrackerid_info").html('The mother does not have a PTracker ID for this pregnancy, please enter the one on the pink book');
									showContainer('#ptrackerid_info');
								}
								else {
									showContainer('#ptrackerid-container-display');
									hideContainer('#ptrackerid-container-input');
									hideContainer('#ptrackerid_info');
									disableContainer('#ptrackerid-container-input'); <!-- Dispable to avoid validating a hidden field -->
								}
								<!-- Clear the previous values -->
								setValue('gravida.value', '');
								setValue('para.value', '');
								setValue('lmp.value', '');
								setValue('edd.value', '');
							}
						});

						jq('#gravida_missing').change(function(){
							handleMissingSelection('gravida');
						});
						jq('#para_missing').change(function(){
							handleMissingSelection('para');
						});
						jq('#lmp_missing').change(function(){
							handleMissingSelection('lmp');
						<!-- Disable EDD if LNMP is missing -->
							if (getValue('lmp_missing.value')) {
								disableContainer('#edd');
								disableContainer('#edd_missing');
							} else {
								enableContainer('#edd');
								enableContainer('#edd_missing');
							}
						});
						jq('#edd_missing').change(function(){
							handleMissingSelection('edd');
						});
						jq('#art_number_missing').change(function(){
							handleMissingSelection('art_number');
						});
						jq('#art_start_date_missing').change(function(){
							handleMissingSelection('art_start_date');
						});
						jq('#refused_art_missing').change(function(){
							handleMissingSelection('refused_art');
						});
						jq('#viral_load_test_date_missing').change(function(){
							handleMissingSelection('viral_load_test_date');
						});
						jq('#viral_load_copies_missing').change(function(){
							handleMissingSelection('viral_load_copies');
						});
						jq('#next_visit_date_missing').change(function(){
							handleMissingSelection('next_visit_date');
						});
					});
				</script>
			</p>
		</div>
	</section>
	<div id="ptrackerid-container" class="">
		<section sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="PTracker ID Capture">
			<div class="section-container">
				<p id="ptrackerid-container-label">
					<label >
						PTracker ID
					</label>
					<p class="hidden narrow" id="ptrackerid-container-display">
						<span id="ptrackerid_readonly" style="color: Black; padding: 2px 4px; ">
							<lookup complexExpression="#if ($fn.latestObs('6c45421e-2566-47cb-bbb3-07586fffbfe2').valueText)
															$fn.latestObs('6c45421e-2566-47cb-bbb3-07586fffbfe2').valueText
														#else
															PTracker ID is Missing
														#end " />
						</span>
					</p>
					<p class="narrow" id="ptrackerid-container-input">
						<obs id="ptrackerid" conceptId="164951" size="5" />
					</p>
					<span id="ptrackerid_info" class="hidden" style="color: Orange; padding: -2px 20px; "></span>

				</p>
			</div>
		</section>
	</div>
	<div id="pregnancy-detail-container" class="">
		<!-- <includeIf velocityTest="$fn.allEncounters('2549af50-75c8-4aeb-87ca-4bb2cef6c69a').size() == 0"> -->
		<section sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="Details of Pregnancy">
			<div class="section-container">
				<p id="gravida-container-label" class="required">
					<label >
						How many times have you been pregnant, including current pregnancy (Gravida)?
					</label>
					<p class="narrow" id="gravida-container-input">
						<obs id="gravida" conceptId="5624AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" size="5" />
						<obs id="gravida_missing" conceptId="164949" style="checkbox" answerLabel="answerLabel" labelText="Gravida missing"/>
					</p>
				</p>
				<p id="para-container-label" class="required">
					<label>
						How many babies have you delivered before (Para)?
					</label>
					<p class="narrow" id="para-container-input">
						<obs id="para" conceptId="1053AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" />
						<obs id="para_missing" conceptId="164933" style="checkbox" answerLabel="answerLabel" labelText="Para missing"/>
					</p>
				</p>

				<p id="lmp-container-label" class="required">
					<label>
						Date of last normal menstrual period (LNMP)
					</label>
					<p class="narrow" id="lmp-container-input">
						<obs conceptId="1427AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" id="lmp" />
						<obs id="lmp_missing" conceptId="164934" style="checkbox" answerLabel="answerLabel" labelText="Date of last normal menstral period missing"/>
					</p>
				</p>
				<p id="edd-container-label" class="required">
					<label>Estimated date of delivery (EDD)</label>
					<p class="narrow" id="edd-container-input">
						<obs id="edd" conceptId="5596AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" allowFutureDates="true" />
						<obs id="edd_missing" conceptId="164935" style="checkbox" answerLabel="answerLabel" labelText="Estimated date of delivery missing"/>
					</p>
				</p>
			</div>
		</section>
		<!-- </includeIf> -->
	</div>
	<section sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="HIV Testing and ART Initiation">
		<script>
			jq(function() {
				<!-- Whether the client has been tested -->
				jq('#hiv-test').click(function(){
					if(getValue('hiv-test.value') == 164912) {
						showContainer('#hiv-test-result-container');
						hideContainer('#refused-test-reason-container');
						hideContainer('#art-number-container');
						hideContainer('#art-startdate-container');
						hideContainer('#art-initiation-container');
						hideContainer('#refused-art-container');
						<!-- don't show viral load items if not known positive -->
						hideContainer('#recent-viral-load-container');
						hideContainer('#viral-load-test-date-container');
						hideContainer('#viral-load-results-container');
						hideContainer('#viral-load-copies-container');
					} else if (getValue('hiv-test.value') == 164911) {
						<!-- previously known positive -->
						showContainer('#art-initiation-container');
						showContainer('#recent-viral-load-container');
						hideContainer('#hiv-test-result-container');
					}else {
						hideContainer('#hiv-test-result-container');
						hideContainer('#art-number-container');
						hideContainer('#art-startdate-container');
						hideContainer('#art-initiation-container');
						hideContainer('#refused-art-container');
						<!-- don't show viral load items if not known positive -->
						hideContainer('#recent-viral-load-container');
						hideContainer('#viral-load-test-date-container');
						hideContainer('#viral-load-results-container');
						hideContainer('#viral-load-copies-container');
			}
				});
				<!-- ART Status -->
				jq('#art-status').click(function(){
					if (getValue('art-status.value') == 'true') {
						<!-- Already on ART -->
						showContainer('#art-number-container');
						showContainer('#art-startdate-container');
						<!-- Enusre ART start date is empty-->
						setValue('art_start_date.value', '');
						showContainer('#recent-viral-load-container');<!-- show viral load regardless of last viral load test -->
						hideContainer('#art-initiation-container');
					} else {
						<!-- Not yet on ART so initialize -->
						hideContainer('#art-number-container');
						hideContainer('#art-startdate-container');
						<!-- don't show viral load items if not on treatment -->
						hideContainer('#recent-viral-load-container');
						hideContainer('#viral-load-test-date-container');
						hideContainer('#viral-load-results-container');
						hideContainer('#viral-load-copies-container');
						showContainer('#art-initiation-container');
					}
				});
				jq('#hiv-test-result').click(function(){
					if(getValue('hiv-test-result.value') == 138571 || getValue('hiv-test-result.value') == 1067) {
						<!-- positive result or unknown (since unknown is a valid answer) -->
						showContainer('#art-initiation-container');
						<!-- showContainer('#art-number-container'); -->
						<!-- showContainer('#art-startdate-container'); -->
					} else {
						hideContainer('#art-initiation-container');
						hideContainer('#art-number-container');
						hideContainer('#art-startdate-container');
						<!-- clear data in case it is not HIV +ve -->
						setValue('art_start_date.value', '');
					}
				});
				jq('#art-initiation').click(function(){
					if(getValue('art-initiation.value') == 160120 || getValue('art-initiation.value') == 160119) {
						showContainer('#art-number-container');
						showContainer('#art-startdate-container');
						hideContainer('#refused-art-container');
					} else if (getValue('art-initiation.value') == 160018) {
						<!-- refused ART -->
						showContainer('#refused-art-container');
						hideContainer('#art-number-container');
						hideContainer('#art-startdate-container');
						setValue('art_start_date.value', '');
					} else {
						hideContainer('#refused-art-container');
						hideContainer('#art-number-container');
						hideContainer('#art-startdate-container');
						setValue('art_start_date.value', '');
					}
				});
			});
		</script>
		<div class="section-container">
			<includeIf velocityTest="$fn.latestObs('164401AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 164911
			|| $fn.latestObs('159427AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 138571 ">
					<!-- Show ART Status and Initiation container if the client is a previously known positive, has been tested with positive -->
					<script>
						<ifMode mode="ENTER">
							jq(function() {
								showContainer('#recent-viral-load-container');
							<includeIf velocityTest="$fn.latestObs('159599AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').obsDatetime == ''"> <!--  but not yet initiated on ART -->
								showContainer('#art-initiation-container');
							</includeIf>
							});
						</ifMode>
					</script>
			</includeIf>
			<!-- Do not show ART testing if previously known positive, tested positive -->
			<!-- <excludeIf velocityTest="$fn.latestObs('159427AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 138571 || $fn.latestObs('164401AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 164911">-->
				<p id="hiv-test-container">
					<label>
						HIV test status
					</label>
					<obs id="hiv-test" style="radio" conceptId="164401AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
						 answerConceptIds="164912,164911,164913,164932"
						 answerLabels="Tested for HIV during this visit,Previously known positive,Not tested for HIV during this visit,Missing" answerSeparator="" />
				</p>
				<p id="hiv-test-result-container" class="">
					<label>
						HIV test result
					</label>
					<obs id="hiv-test-result" style="radio" conceptId="159427AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerConceptIds="664,138571,1067,164932"
						 answerLabels="Negative,Positive,Unknown,Missing"
						 answerSeparator="" />
				</p>

			<!-- </excludeIf> -->

			<!-- TODO: to remove code cleanup after UAT -->
			<!-- <excludeIf velocityTest="$fn.latestObs('159599AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').obsDatetime">--><!-- exclude ART initiation if ART initiation date exists -->
            <!-- <p id="art-status-container" class="" >
                <obs id="art-status" conceptId="164914" answerSeparator="" style="checkbox" />
				<label>Are you still on treatment?</label>
            </p> -->
			<p id="art-initiation-container" class="">
			<label>
				ART initiation
			</label>
				<obs id="art-initiation" style="radio" conceptId="164915"
					 answerConceptIds="160119,160120,160018,1754,164932"
					 answerLabels="Already on ART before current pregnancy,Started on ART in ANC current pregnancy,Refused ART,Not started due to stockout of ART,Missing" answerSeparator="" />
			</p>
			<p id="art-number-container" class="narrow">
					<label>ART Unique Number</label>
				<span id="art_number">
					<patient field="identifier" identifierTypeId="9d6d1eec-2cd6-4637-a981-4a46b4b8b41f"  required="false" />
				</span>
					<obs id="art_number_missing" conceptId="164936" style="checkbox" answerLabel="answerLabel" labelText="ART Unique Number missing"/>
			</p>
			<p id="refused-art-container" class="">
				<label>Reason for refusing ART initiation</label>
				<obs id="refused_art" conceptId="163322AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" />
				<obs id="refused_art_missing" conceptId="164937" style="checkbox" answerLabel="answerLabel" labelText="Reason for refusing ART initiation missing"/>
			</p>
			<p id="art-startdate-container" class="narrow">
				<label>ART start date</label>
				<obs id="art_start_date" conceptId="159599AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" />
				<obs id="art_start_date_missing" conceptId="164938" style="checkbox" answerLabel="answerLabel" labelText="ART start date missing"/>
				<script>
					jq(function(){
						jq('#art_start_date :input[type=text]').change(function(){
							
							var art_start_date = getValue('art_start_date.value');
							var visit_date = getValue('encounterDate.value');
							
							if (art_start_date != '') {
								<!-- check that the ART start date is not after the visit date -->
								if (art_start_date &gt; visit_date) {
									alert('The ART start date cannot be after the date of this visit ' +  changeFieldDateToJavascriptDate(visit_date));
								} else {
									var diff = Math.abs(new Date(changeFieldDateToJavascriptDate(visit_date)) - new Date(changeFieldDateToJavascriptDate(art_start_date)));
									<!-- Show the viral load container if the ART start date is more than 6 months before today -->

									<!-- just show the viral load container -->
										showContainer('#recent-viral-load-container');
								}
							}
						});
					});
				</script>
				
			</p>
			<!-- </excludeIf> -->
				<p id="recent-viral-load-container" class="">
					<label>
						Viral Load test done? 					</label>
					<obs style="radio" conceptId="163310AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" id="recent-viral-load" answerConceptIds="1065, 1066, 164932"
						 answerLabels="Yes, No, Missing"
						 answerSeparator="" />
					<script>
						jq(function() {
							jq('#recent-viral-load').click(function(){
								if (getValue('recent-viral-load.value') == 1065) {
									showContainer('#viral-load-results-container');
									showContainer('#viral-load-test-date-container');
								} else {
									hideContainer('#viral-load-results-container');
									hideContainer('#viral-load-test-date-container');
									hideContainer('#viral-load-copies-container');
        }
    });
});
</script>

</p>

<!-- TODO: Add handling for the second viral load result -->
			<p id="viral-load-test-date-container" class="narrow">
				<label>Viral load test date</label>
				<obs conceptId="163281" id="viral_load_test_date"/>
				<obs id="viral_load_test_date_missing" conceptId="164939" style="checkbox" answerLabel="answerLabel" labelText="Viral load test date missing"/>
			</p>
			<p id="viral-load-results-container" class="">
				<label>Viral load results</label>
				<obs id="viral-load-results" conceptId="1305AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerConceptIds="1301,1306,1304,159971, 164932" style="radio"
					 answerSeparator=""
					 answerLabels="Target Detected,Not Detected, Sample Rejected, Results Pending, Missing"/>
				<script>
						jq(function() {
							jq('#viral-load-results').click(function(){
								if (getValue('viral-load-results.value') == 1301) {
									showContainer('#viral-load-copies-container');
								} else {
									hideContainer('#viral-load-copies-container');
								}
							});
						});
					</script>
			</p><br/>
			<p id="viral-load-copies-container" class="narrow">
				<label>Viral load (copies/ml)</label>

				<obs id="viral_load_copies"  unitsCssClass="append-to-value" conceptId="856AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"/>

				<obs id="viral_load_copies_missing" conceptId="164940" style="checkbox" answerLabel="answerLabel" labelText="Viral load copies missing"/>
			</p>
		</div>
	</section>
	<section sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="Followup">
		<script>
			jq(function() {
				jq('#transfer-out').click(function(){
					if (getValue('transfer-out.value') == 160036) {
						showContainer('#transfer-out-to-container');
					} else {
						hideContainer('#transfer-out-to-container');
					}
				});
			});
		</script>
		<div class="section-container">
			<p id="next-visit-date-container" class="narrow">
				<label>Next Visit Date</label>
				<obs id="next_visit_date" conceptId="5096AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" allowFutureDates="true" />
				<obs id="next_visit_date_missing" conceptId="164941" style="checkbox" answerLabel="answerLabel" labelText="Next visit date missing"/>
			</p>
			<p id="transfer-out-container">
				<label>Facility of next appointment</label>
				<obs id="transfer-out" style="radio" conceptId="164916" answerConceptIds="163266,164917,160036,164932" answerLabels="This facility,In Transit,Transfer out,Missing" answerSeparator=""/>
			</p>
			<p id="transfer-out-to-container" class="">
				<label>Transfer to</label>
				<obs id="transfer-out-to" conceptId="159495AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" style="location" answerLocationTags="2" />
			</p>
		</div>
	</section><br />
	<submit class="confirm center" />
</htmlform>