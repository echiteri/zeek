<htmlform formName="Labour and Delivery Form"
		  formDescription="A visit for a mother for Labour and Delivery services"
		  formEncounterType="2678423c-0523-4d76-b0da-18177b439eed"
		  formUuid="1e5614d6-5306-11e6-beb8-9e71128cae77"
		  formVersion="0.9"
		  formAddMetadata="yes"
		  formUILocation="patientDashboard.overallActions"
		  formOrder="5"
		  formIcon="icon-medkit"
		  formShowIf="patient.person.dead==false &amp;&amp; patient.person.gender=='F' &amp;&amp; patient.person.age &gt; 12"
		  formDisplayStyle="Standard">

	<script type="text/javascript">
		jq(function() {
			<!--/* Show the current location and visit date while hiding the encounter location drop down and date picker for
			encounter date */-->
			jq('#encounterLocation').hide();
			jq('#currentLocation').text(jq('#encounterLocation select option:selected').text());
			<ifMode mode="ENTER">
				<!-- the encounter date should be empty on a new form -->
				setValue('encounterDate.value', '');
			</ifMode>


			<lookup complexExpression="
					#set( $encounter = 0 )
					#set( $encounter = $fn.latestEncounter('2678423c-0523-4d76-b0da-18177b439eed'))
					#if( $encounter != 0 )
						var lastLAndDEncounter = jq.datepicker.parseDate('yy-mm-dd','$encounter.encounterDatetime');
						var now = new Date();
						var timeFromLastEncounter = Math.floor((now.getTime() - lastLAndDEncounter.getTime())/(86400000 * 30));
						if (timeFromLastEncounter &lt; 7) {
							jq().toastmessage('showToast',{
								text : 'There is a Labor and Delivery record that is less than 7 months old, so a new record cannot be added. \n\n You will now be taken back to the patient dashboard.',
								stayTime: 10000,
								type: 'error'
								}
							);
							setTimeout(function(){
									window.location.href = window.location.protocol + &quot;//&quot; + window.location.host + &quot;/&quot;+ OPENMRS_CONTEXT_PATH + &quot;/coreapps/clinicianfacing/patient.page?patientId=$encounter.patient.patientId&quot;;
								},
								10000);

						}
					#end"/>
		
			beforeSubmit.push(function() {
				<!-- validation rules -->
		<!-- Validation rules for Testing and Initiation -->
		<!-- Validate HIV test done -->
				if ($('#hiv-test').length > 0) { <!-- check the existence of the element, in case it is excluded from the form based on previous known state -->
					setValue('hiv-test.error', '');
					if (!getValue('hiv-test.value')) {
						getField('hiv-test.error').html('HIV test must be provided').show();
						return false;
					}
				}

				<!-- Validate HIV test result -->
				if ($('#hiv-test-result').length > 0) { <!-- check the existence of the element, in case it is excluded from the form based on previous known state -->
					setValue('hiv-test-result.error', '');
					<!-- if there is a test the test result is required -->
					if (getValue('hiv-test.value') == 164912) {
						if (!getValue('hiv-test-result.value')) {
							getField('hiv-test-result.error').html('The results for the HIV test must be provided').show();
							return false;
						}
					}
				}

				<!-- Validate ART Initiation -->
				if ($('#art-initiation').length > 0) { <!-- check the existence of the element, in case it is excluded from the form based on previous known state -->
					setValue('art-initiation.error', '');
					<!-- the art initiation is required  if Test status is done and results is P, or KP -->
					if ($('#hiv-test').length > 0 &amp;&amp; $('#hiv-test-result').length > 0){
						if (((getValue('hiv-test.value') == 164912 &amp;&amp; getValue('hiv-test-result.value')  == 138571) || getValue('hiv-test.value') == 164911)) {
								if (!getValue('art-initiation.value')) {
								getField('art-initiation.error').html('ART initiation status must be provided').show();
								return false;
						}
					}
				} else {
						if (!getValue('art-initiation.value')) {
							getField('art-initiation.error').html('ART initiation status must be provided').show();
							return false;
						}
					}
				}
				<!-- Validate recent viral load done-->
				if ($('#recent-viral-load').length > 0) { <!-- check the existence of the element, in case it is excluded from the form based on previous known state -->
					setValue('recent-viral-load.error', '');
					<!-- the recent-viral-load is required if Test status is KP -->
					if ($('#hiv-test').length > 0){
						if (getValue('hiv-test.value') == 164911){
							if (!getValue('recent-viral-load.value')) {
								getField('recent-viral-load.error').html('Recent viral load must be provided').show();
								return false;
						}
					}
				}else {
					if (!getValue('recent-viral-load.value')) {
							getField('recent-viral-load.error').html('Recent viral load must be provided').show();
							return false;
						}
					}
				}

				<!-- Validate viral load results done-->
				if ($('#viral-load-results').length > 0) { <!-- check the existence of the element, in case it is excluded from the form based on previous known state -->
					setValue('viral-load-results.error', '');
					<!-- the viral-load-results is required  -->
					if (getValue('recent-viral-load.value') == 1065){
						if (!getValue('viral-load-results.value')) {
							getField('viral-load-results.error').html('Viral load results must be provided').show();
							return false;
						}
					}
				}
				<!-- Breast feeding status only required if mother and baby are alive -->
				<!-- TODO: Add required checks for breast feeding status when the mother and baby are alive -->
				<!-- TODO: Add required check for infant propylaxis status if alive from birth -->
				var babiesBorn = getValue('birth-count.value');
				var isValid = true;
				var regex = /^[0-9]{5}[A-S]{1}[0-9]{7,8}$$/; <!-- ID format: 12345A170001 Mother Min or 12345A17000112 Infant Max  -->
				for (i=1; i &lt; 10; i++) {
					setValue('infant-gender-' + i + '.error', '');
					setValue('infant_birth_date_' + i + '.error', '');
					setValue('infant-status-' + i + '.error', '');
					setValue('still-birth-' + i + '.error', '');
					setValue('infant-arv-prophylaxis-' + i + '.error', '');
					setValue('breastfeeding-' + i + '.error', '');
					if (i &lt;= babiesBorn) {
						if (!getValue('infant-gender-' + i + '.value')) {
							getField('infant-gender-' + i + '.error').html('Please select the sex').show();
							isValid = false;
						}
						if (!getValue('infant-status-' + i + '.value')) {
							getField('infant-status-' + i + '.error').html('Please enter the infant status').show();
							isValid = false;
						}
						<!-- Date of Birth is required for alive babies or neo-natal death -->
						if (getValue('infant-status-'+ i + '.value') == 151849 || getValue('infant-status-'+ i + '.value') == 154223) {

							if(getValue('infant-status-'+ i + '.value') != 154223){<!-- Don't check if neo-natal death -->
								<!--if(!getValue('infant_birth_date_' + i + '_missing.value')) --> <!-- validate if the value is not missing -->
								<!--{ --> <!-- Check infant date of birth -->
									if (!getValue('infant_birth_date_' + i + '.value')) {
										getField('infant_birth_date_' + i + '.error').html('Please enter the date of birth').show();
										isValid = false;
									}
								<!--}-->
								<!-- if(!getValue('infant_birth_date_' + i + '_missing.value')) --> <!-- validate if the value is not missing -->
								<!-- { -->
									<!-- Check the Infant PTracker ID  -->
									if (!getValue('child_number_' + i + '.value')) {
										getField('child_number_' + i + '.error').html('Please enter the Infant PTracker ID').show();
										isValid = false;
									}
									<!-- Check if the Infant PTracker ID meets the Regex -->
									if(!regex.test(getValue('child_number_' + i + '.value'))){
										getField('child_number_' + i + '.error').html('PTracker ID format is wrong.').show();
										isValid = false;
									}
								<!--} -->
							}
							if(getValue('hiv-test-result.value') == 138571
								|| getValue('hiv-test-result.value') == 1067
								|| getValue('anc-retest-thirty-six-weeks.value') == 138571
								|| getValue('anc-retest-thirty-six-weeks.value') == 1067)
							{ <!-- Only validate when HIV test result and ANC Retest at 36 weeks is positive or Unknown -->
								if (!getValue('infant-arv-prophylaxis-' + i + '.value')) {
									getField('infant-arv-prophylaxis-' + i + '.error').html('Please enter the infant arv prophylaxis').show();
									isValid = false;
								}
							}

							if (!getValue('breastfeeding-' + i + '.value')) {
								getField('breastfeeding-' + i + '.error').html('Please enter the infant breastfeeding status').show();
								isValid = false;
							}
						} else {
							<!-- For still births the type of still birth is required -->
							if (getValue('infant-status-'+ i + '.value') == 125872) {
								if (!getValue('still-birth-' + i + '.value')) {
									getField('still-birth-' + i + '.error').html('Please enter the type of still birth').show();
									isValid = false;
								}
							}
						}
						
						
					}
				}
				return isValid;
			});
			jq('#art_number_missing').change(function(){
				handleMissingSelection('art_number');
			});
			jq('#art_start_date_missing').change(function(){
				handleMissingSelection('art_start_date');
			});
			jq('#refused_art_missing').change(function(){
				handleMissingSelection('refused_art');
			});
			jq('#viral_load_test_date_missing').change(function(){
				handleMissingSelection('viral_load_test_date');
			});
			jq('#viral_load_copies_missing').change(function(){
				handleMissingSelection('viral_load_copies');
			});

		});
	</script>
	
	<style>
		#summary th {
			text-align: left;
			white-space: nowrap;
		}
	</style>
	<postSubmissionAction class="org.openmrs.module.namibia.htmlformentry.InfantRegistrationAtLaborAndDeliverySubmissionAction"/>
	<h2>
		<label>
			Labour and Delivery Form
		</label>
	</h2>
	<table id="who-when-where">
		<tbody>
			<tr>
				<td>
					<label>
						Attending Clinican
					</label>
					<encounterProvider default="currentUser" />
				</td>
				<td>
					<label>
						Health Facility
					</label>
					<span id="currentLocation"></span>
					<encounterLocation default="SessionAttribute:emrContext.sessionLocationId"
									   tags="1" /> <!-- Only show Login locations -->
				</td>
				<td>
					<label name="encounterDate">
						Visit Date
					</label>
					<encounterDate disallowMultipleEncountersOnDate="block" />
				</td>
			</tr>
		</tbody>
	</table>
	<section sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="Admission Information">
		<div class="section-container">
			<table id="summary">
				<tr>
					<th>Age (Yrs)</th>
					<th>Telephone Number</th>
					<th>No of ANC Visits</th>
				</tr>
				<tr>
					<td><lookup expression="patient.age"/></td>
					<td><lookup expression="personAttributes.get('Telephone Number')"/></td>
					<td><lookup	complexExpression="$fn.allEncounters('2549af50-75c8-4aeb-87ca-4bb2cef6c69a').size()"/></td>
				</tr>
				<includeIf velocityTest="$fn.allEncounters('2549af50-75c8-4aeb-87ca-4bb2cef6c69a').size() > 0">
					<!-- todo: Show HIV and ART status if the encounter facility is similar to patient last encounter facility-->
				<!-- <tr>
					<th>HIV Status</th>
					<th>ART Status</th>
					<th>ART Unique Number</th>
				</tr> -->
				<!-- <tr>
					<td> -->
						
					<!-- Start with Previously known Positive -->
					<!-- <includeIf velocityTest="$fn.latestObs('164401AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 1169">
						Previously Known Positive
					</includeIf>
					<includeIf velocityTest="$fn.latestObs('164401AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 1065">
						<lookup	complexExpression="$fn.latestObs('1396AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.name"/> on <lookup	complexExpression="$fn.latestObs('1396AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').obsDatetime"/>
					</includeIf>
					</td>
					<td>
                        <includeIf velocityTest="$fn.latestObs('160117AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA')">
                            <lookup	complexExpression="$fn.latestObs('160117AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.name"/>
                        </includeIf>
                        <includeIf velocityTest="$fn.latestObs('159599AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA')">
                            Since <lookup	complexExpression="$fn.latestObs('159599AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').obsDatetime"/>
                        </includeIf>
					</td>
					<td><lookup	expression="patient.getPatientIdentifier('ART Unique Number')"/></td>
				</tr> todo: above ends here-->
				<tr>
					<th>Last ANC Visit Date</th>
					<th>Referral ANC Clinic</th>
					<th>ANC Provider Name</th>
				</tr>
				<tr>
					<td><lookup	complexExpression="$fn.latestEncounter('2549af50-75c8-4aeb-87ca-4bb2cef6c69a').encounterDatetime"/></td>
					<td><lookup	complexExpression="$fn.latestEncounter('2549af50-75c8-4aeb-87ca-4bb2cef6c69a').location.name" /></td>
					<td>
						<lookup	complexExpression="#foreach($encounterProvider in $fn.latestEncounter('2549af50-75c8-4aeb-87ca-4bb2cef6c69a').encounterProviders) $encounterProvider.provider.person.personName #end" />
						
					</td>
				</tr>
				</includeIf>
			</table>
		</div>
	</section>
    <includeIf velocityTest="$fn.latestObs('159427AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 138571 || $fn.latestObs('164401AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 164911">
        <!-- Show ART Status and Inititation if the client has tested positive, is a previously known positive. Need to establish if still on care-->
        <script>
            jq(function() {
				hideContainer('#hiv-test-container');
				showContainer('#recent-viral-load-container');
				showContainer('#art-initiation-container');
				<!-- Show the prophylaxis for the infants if mother is KP -->
				jq(".prophylaxis").each(function(){
					showContainer("#" + jq(this).attr("id"));
				});
            });
        </script>
    </includeIf>
    <!-- <includeIf velocityTest="$fn.allEncounters('2549af50-75c8-4aeb-87ca-4bb2cef6c69a').size() &lt;1"> -->
	<!-- TODO: check 1) if there is previouse anc visit 2) If there is an exisiting PTrackerId 3) The last existing encounter is how old -->
        <section sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="Delivery Information">
            <div class="section-container">
                    <!--
                    <p id="pregnancy-number-container" class="narrow">
                        <label>
                            PTracker Pregnancy Number
                        </label>
                        <obs id="pregancy-number" conceptId="161655AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" />
                    </p>
                    -->
                <p>
                    <label>
                        Was this client booked (Does Client have a pink book?) at ANC?
                    </label>
                    <obs id="client-booked" style="radio" conceptId="1719AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerSeparator="" answerConceptIds="1065,1066,164932" answerLabels="Yes, No, Missing"/>
					<script>
						jq(function() {

						var now = new Date();
						var ptrackerIDLastObsDate = new Date($('#ptrackerid_datetime').text().trim());
						var timeFromLastPregnancy = Math.floor((now.getTime() - ptrackerIDLastObsDate.getTime())/(86400000 * 30));

							<!-- requires capturing of PTracker ID -->
							<!-- jq('#ptrackerid-container-display').hide(); -->
							jq('#client-booked').click(function(){
								if (getValue('client-booked.value') == 1066){
									showContainer('#ptrackerid-container'); <!-- show the entire container -->
									showContainer('#ptrackerid-container-input');
									hideContainer('#ptrackerid-container-display');
								} else if(getValue('client-booked.value') == 1065){
									showContainer('#ptrackerid-container');  <!-- Show container to display the Read Only PTrackerID -->
									if($('#ptrackerid_readonly').text().trim() == "PTrackerID is Missing"){ <!-- the PTrackerID is missing, allow user to capture another -->
										showContainer('#ptrackerid-container-display');
										showContainer('#ptrackerid-container-input');
									}
									else if($('#ptrackerid_readonly').text().trim() != "PTrackerID is Missing") { <!-- If the latest PTrackerID is older than 7 months allow another to be captured -->
										if(timeFromLastPregnancy &gt; 7){
											alert("The existing PTrackerID is more than 7 months. Kindly provide another PTrackerID");
											showContainer('#ptrackerid-container-display');
											showContainer('#ptrackerid-container-input');
										} else {
											showContainer('#ptrackerid-container-display');
											hideContainer('#ptrackerid-container-input');
										}
									}
									<!-- showContainer('#ptrackerid-container-display');
									hideContainer('#ptrackerid-container-input'); -->
								}
							});
						});
					</script>
                </p>
            </div>
        </section>
    <!-- </includeIf> -->
	<div id="ptrackerid-container" class="hidden">
		<section sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="PTrackerID Capture">
			<div class="section-container">
				<p id="ptrackerid-container-label">
					<label >
						PTrackerID
					</label>
					<p class="narrow" id="ptrackerid-container-display">
						<span id="ptrackerid_readonly" style="background: white; color: black; padding: 2px 4px; ">
							<lookup complexExpression="
								#set( $ptrackerid = $fn.latestObs('6c45421e-2566-47cb-bbb3-07586fffbfe2'))
								#if ($ptrackerid)
										$ptrackerid.valueText
										#set($ptrackerid_date = $ptrackerid.obsDatetime)
								#else
									PTrackerID is Missing
								#end " />
						</span>
						<span id="ptrackerid_datetime" class="hidden">
							<lookup complexExpression="$ptrackerid.obsDatetime" />
						</span>
					</p>
					<p class="narrow hidden" id="ptrackerid-container-input">
						<obs id="ptrackerid" conceptId="164951" size="5" />
					</p>
				</p>
			</div>
		</section>
	</div>
	<!--
	Show the HIV testing questions if
	- No HIV Test was done during antenatal
	- Not tested because of test kit stockout
	- TODO: Add a test when the last test was negative, and its more than 3 months since that test
	-->
	<includeIf velocityTest="$fn.latestObs('159427AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId != 138571 ||  $fn.latestObs('164401AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA') != 1169"> <!--#zeek - changed from: !$fn.latestObs('164401AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA') -->
			
	<section sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="HIV Status at Delivery">
		<script>
			jq(function() {
				<!-- Whether the client has been tested -->
				jq('#hiv-test').click(function(){
					if(getValue('hiv-test.value') == 164912) {
						showContainer('#hiv-test-result-container');

						hideContainer('#art-number-container');
						hideContainer('#art-startdate-container');
						hideContainer('#art-initiation-container');
						hideContainer('#refused-art-container');
						hideContainer('#anc-retest-thirty-six-weeks-container');
						<!-- don't show viral load items if not known positive -->
						hideContainer('#recent-viral-load-container');
						hideContainer('#viral-load-test-date-container');
						hideContainer('#viral-load-results-container');
						hideContainer('#viral-load-copies-container');
						<!-- clear the art date -->
						setValue('art_start_date.value', '');
					} else if (getValue('hiv-test.value') == 164911) {
						<!-- previously known positive -->
                        showContainer('#art-initiation-container');
						showContainer('#recent-viral-load-container');
						hideContainer('#hiv-test-result-container');
						hideContainer('#anc-retest-thirty-six-weeks-container');
						<!-- Show the prophylaxis for the infants -->
						jq(".prophylaxis").each(function(){
							showContainer("#" + jq(this).attr("id"));
						});
					} else if(getValue('hiv-test.value') == 164913) {
						<!-- Not tested -->

                        showContainer('#anc-retest-thirty-six-weeks-container');
						hideContainer('#hiv-test-result-container');
						hideContainer('#art-number-container');
						hideContainer('#art-startdate-container');
						hideContainer('#art-initiation-container');
						hideContainer('#refused-art-container');
						hideContainer('#recent-viral-load-container');
						hideContainer('#viral-load-test-date-container');
						hideContainer('#viral-load-results-container');
						hideContainer('#viral-load-copies-container');
						<!-- clear the art date -->
						setValue('art_start_date.value', '');
					} else {
						hideContainer('#hiv-test-result-container');
						hideContainer('#art-number-container');
						hideContainer('#art-startdate-container');
						hideContainer('#art-initiation-container');
						hideContainer('#refused-art-container');
						hideContainer('#anc-retest-thirty-six-weeks-container');
						<!-- don't show viral load items if not known positive -->
						hideContainer('#recent-viral-load-container');
						hideContainer('#viral-load-test-date-container');
						hideContainer('#viral-load-results-container');
						hideContainer('#viral-load-copies-container');
						<!-- clear the art date -->
						setValue('art_start_date.value', '');
					}
				});

				<!-- ANC Re-test at 36 weeks -->
				jq('#anc-retest-thirty-six-weeks').click(function(){
				<!-- positive or unknown -->
					if(getValue('anc-retest-thirty-six-weeks.value') == 138571 || getValue('anc-retest-thirty-six-weeks.value') == 1067) {
						showContainer('#art-initiation-container');
						showContainer('#recent-viral-load-container');
						<!-- show the prophylaxis for the infants -->
						jq(".prophylaxis").each(function(){
							showContainer("#" + jq(this).attr("id"));
						});
					} else {
						<!-- restore the state of the containers before positive selection -->
						hideContainer('#hiv-test-result-container');
						hideContainer('#art-number-container');
						hideContainer('#art-startdate-container');
						hideContainer('#art-initiation-container');
						hideContainer('#refused-art-container');
						hideContainer('#recent-viral-load-container');
						hideContainer('#viral-load-test-date-container');
						hideContainer('#viral-load-results-container');
						hideContainer('#viral-load-copies-container');
						<!-- hide the prophylaxis for the infants -->
						jq(".prophylaxis").each(function(){
							hideContainer("#" + jq(this).attr("id"));
						});
						<!-- clear the art date -->
						setValue('art_start_date.value', '');
					}
				});

				<!-- ART Status -->
				jq('#art-status').click(function(){
					if (getValue('art-status.value') == 'true') {
						<!-- Already on ART -->
						showContainer('#art-number-container');
						showContainer('#art-startdate-container');
						<!-- Enusre ART start date is empty -->
						setValue('art_start_date.value', '');
						showContainer('#recent-viral-load-container');<!-- show viral load regardless of last viral load test -->
						hideContainer('#art-initiation-container');
					} else {
						<!-- Not yet on ART so initialize -->
						hideContainer('#art-number-container');
						hideContainer('#art-startdate-container');
						<!-- don't show viral load items if not on treatment -->
						hideContainer('#recent-viral-load-container');
						hideContainer('#viral-load-test-date-container');
						hideContainer('#viral-load-results-container');
						hideContainer('#viral-load-copies-container');
					}
				});
				jq('#hiv-test-result').click(function(){
					if(getValue('hiv-test-result.value') == 138571 || getValue('hiv-test-result.value') == 1067) {
						<!-- positive result or Unknown (since Unknown is an answer)-->
						showContainer('#art-initiation-container');
						<!-- showContainer('#art-number-container');
						showContainer('#art-startdate-container'); -->
						<!-- show the prophylaxis for the infants -->
						jq(".prophylaxis").each(function(){
							showContainer("#" + jq(this).attr("id"));
						});
					} else {
						<!-- negative result -->
						hideContainer('#art-initiation-container');
						hideContainer('#art-number-container');
						hideContainer('#art-startdate-container');
						<!-- hide the prophylaxis for the infants -->
						jq(".prophylaxis").each(function(){
							hideContainer("#" + jq(this).attr("id"));
						});
						setValue('art_start_date.value', '');
					}
				});
				jq('#art-initiation').click(function(){
					if(getValue('art-initiation.value') == 160120 || getValue('art-initiation.value') == 160119) {
						showContainer('#art-number-container');
						showContainer('#art-startdate-container');
						hideContainer('#refused-art-container');
					} else if (getValue('art-initiation.value') == 160018) {
						<!-- refused ART -->
						showContainer('#refused-art-container');
						hideContainer('#art-number-container');
						hideContainer('#art-startdate-container');
						setValue('art_start_date.value', '');
					} else {
						hideContainer('#refused-art-container');
						hideContainer('#art-number-container');
						hideContainer('#art-startdate-container');
						setValue('art_start_date.value', '');
					}
				});
			});
		</script>
		<div class="section-container">
			<!-- Do not show the testing if
				- client is previously known positive
				- client refused test
				- client tested and test was positive or negative
			-->
			<!-- Do not show ART testing if previously known positive, tested positive -->
			<excludeIf velocityTest="$fn.latestObs('159427AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 138571 || $fn.latestObs('164401AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 164911">

			<p id="hiv-test-container" class="">
				<label>
					HIV Test Status
				</label>
				<obs id="hiv-test" style="radio" conceptId="164401AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
					 answerConceptIds="164912,164911,164913,164932"
					 answerLabels="Tested for HIV during this visit,Previously known positive,Not tested for HIV during this visit,Missing"
					  answerSeparator="" />
			</p>
				<p id="anc-retest-thirty-six-weeks-container" class="hidden">
					<label>
						ANC Re-test HIV Status >= 36 weeks
					</label>
					<obs id="anc-retest-thirty-six-weeks" style="radio" conceptId="159803AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
						 answerConceptIds="664,138571,1067,164913, 164932"
						 answerLabels="Negative,Positive,Unknown, Not tested for HIV during this visit, Missing"
						 answerSeparator=""  />
				</p>
				<p id="hiv-test-result-container" class="hidden">
				<label>
					HIV Test Result
				</label>
				<obs id="hiv-test-result" style="radio" conceptId="159427AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerConceptIds="664,138571,1067,164932"
					 answerLabels="Negative,Positive,Unknown, Missing"
					 answerSeparator="" />
			</p>
			</excludeIf>
            <excludeIf velocityTest="$fn.latestObs('159599AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').obsDatetime"><!-- exclude ART initiation if ART initiation date exists -->
            <p id="art-status-container" class="hidden" >

                <obs id="art-status" conceptId="164914" answerSeparator="" style="checkbox" />
				<label>Are you still on treatment?</label>

            </p>
			<p id="art-initiation-container" class="hidden">
			<label>
				ART initiation
			</label>
				<obs id="art-initiation" style="radio" conceptId="164915"
					 answerConceptIds="160119,160120,160018,1754,164932"
					 answerLabels="Already on ART,Started on ART during Labour and Delivery,Refused ART,Not started due to stockout of ART,Missing" answerSeparator="" />
			</p>

			<p id="art-number-container" class="hidden narrow">
					<label>ART Unique Number</label>
				<span id="art_number">
					<patient field="identifier" identifierTypeId="9d6d1eec-2cd6-4637-a981-4a46b4b8b41f"  required="false" />
				</span>
					<obs id="art_number_missing" conceptId="164936" style="checkbox" answerLabel="answerLabel" labelText="ART Unique Number missing"/>
			</p>

			<p id="refused-art-container" class="hidden">
				<label>Reason for refusing ART initiation</label>
				<obs id="refused_art" conceptId="163322AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" />
				<obs id="refused_art_missing" conceptId="164937" style="checkbox" answerLabel="answerLabel" labelText="Reason for refusing ART initiation missing"/>
			</p>
			<p id="art-startdate-container" class="hidden narrow">
				<label>ART start date</label>
				<obs id="art_start_date" conceptId="159599AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" />
				<obs id="art_start_date_missing" conceptId="164938" style="checkbox" answerLabel="answerLabel" labelText="ART start date missing"/>
				<script>
					jq(function(){
						jq('#art_start_date :input[type=text]').change(function(){
							
							var art_start_date = getValue('art_start_date.value');
							var visit_date = getValue('encounterDate.value');
							
							if (art_start_date != '') {
								<!-- check that the ART start date is not after the visit date -->
								if (art_start_date &gt; visit_date) {
									alert('The ART start date cannot be after the date of this visit ' +  changeFieldDateToJavascriptDate(visit_date));
								} else {
									var diff = Math.abs(new Date(changeFieldDateToJavascriptDate(visit_date)) - new Date(changeFieldDateToJavascriptDate(art_start_date)));
                                    showContainer('#recent-viral-load-container');
								}
							}
						});
					});
				</script>
				
			</p>
			</excludeIf>
            <p id="recent-viral-load-container" class="hidden">
                <label>
                    Viral Load test done? 					</label>
                <obs style="radio" conceptId="163310AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" id="recent-viral-load" answerConceptIds="1065, 1066, 164932"
                     answerLabels="Yes, No, Missing"
                     answerSeparator="" />
                <script>
                    jq(function() {
                        jq('#recent-viral-load').click(function(){
                            if (getValue('recent-viral-load.value') == 1065) {
                                showContainer('#viral-load-results-container');
                                showContainer('#viral-load-test-date-container');
                            } else {
                                hideContainer('#viral-load-results-container');
                                hideContainer('#viral-load-test-date-container');
                                hideContainer('#viral-load-copies-container');
                            }
                        });
                    });
                </script>

            </p>

            <!-- TODO: Add handling for the second viral load result -->
            <p id="viral-load-test-date-container" class="narrow hidden">
                <label>Viral load test date</label>
                <obs conceptId="163281" id="viral_load_test_date"/>
				<obs id="viral_load_test_date_missing" conceptId="164939" style="checkbox" answerLabel="answerLabel" labelText="Viral load test date missing"/>
            </p>
            <p id="viral-load-results-container" class="hidden">
                <label>Viral load results</label>
                <obs id="viral-load-results" conceptId="1305AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerConceptIds="1301,1306,1304,159971,164932" style="radio"
                     answerSeparator=""
                     answerLabels="Target Detected,Not Detected, Sample Rejected, Results pending, Missing"/>
                <script>
                    jq(function() {
                        jq('#viral-load-results').click(function(){
                            if (getValue('viral-load-results.value') == 1301) {
                                showContainer('#viral-load-copies-container');
                            } else {
                                hideContainer('#viral-load-copies-container');
                            }
                        });
                    });
                </script>
            </p><br/>
            <p id="viral-load-copies-container" class="narrow hidden">
                <label>Viral load (copies/ml)</label>

                <obs id="viral_load_copies" unitsCssClass="append-to-value" conceptId="856AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"/>
				<obs id="viral_load_copies_missing" conceptId="164940" style="checkbox" answerLabel="answerLabel" labelText="Viral load copies missing"/>

            </p>
		</div>
	</section>
	</includeIf>
	<section sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="Mother and Infant Status">
	<div class="section-container">
		<script>
			jq(function(){
				var babies = 0;
				jq('#birth-count').click(function(){
					babies = getValue('birth-count.value');
					for (i=0; i &lt; 10; i++) {
						if (i &lt; babies) {
							showContainer('#' + (i +1) + '-toggleContainer');
						} else {
							<!-- hide the rest of the containers just in case a higher number was selected before -->
							hideContainer('#' + (i +1) + '-toggleContainer');
						}
					}
				});
				jq(function(){
					jq('#mother-status').click(function(){
						<!-- Hide breast feeding status if the mother died -->
						if (getValue('mother-status.value') == 134612) {
							for (i=0; i &lt; 10; i++) {
								hideContainer('#breastfeeding-container-' + i );
							}
						} else {
							for (i=0; i &lt; 10; i++) {
								if (getValue('infant-status-' + i + '.value') == '' || getValue('infant-status-' + i + '.value') == 151849) {
									showContainer('#breastfeeding-container-' + 1);
								}
							}
							
						}
						if (getValue('mother-status.value') == 1692) {
							showContainer('#discharge-date-container');
						}else {
							hideContainer('#discharge-date-container');
						}
					});
				});
				<!-- Show the babies information by triggering a click on the number of babies field -->
				jq('#birth-count').trigger("click");
			});
		</script>
		<p>
			<label>
				Mother's status
			</label>
			<obs id="mother-status" style="radio" conceptId="1856AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerConceptIds="161636,134612,159492,1692,164932"
				 answerLabels="Still in Care,Mother Died (Maternal Death),Transferred Out (Still Alive), Discharged (Still Alive), Missing" answerSeparator="" required="true"/>
		</p>
		<p id="discharge-date-container" class="narrow hidden">
			<label>Discharge Date</label>
			<obs style="date" id="discharge-date" showTime="false" conceptId="1641AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"/>
		</p>
		<p>
			<label>Number of babies born from this pregnancy</label>
			<obs id="birth-count" conceptId="1568AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" required="true" answers="1,2,3,4,5,6,7,8,9,10" answerLabels="1,2,3,4,5,6,7,8,9,10"/>
		</p>

		<repeat>
			<template>
				<div id="{n}-toggleContainer" class="hidden">
					<h3>Child # {n}</h3>
					<script>
						jq(function(){

						
							jq('#infant-status-{n}').click(function(){
								<!-- hide breast feeding and prophylaxis status if baby died -->
								if (getValue('infant-status-{n}.value') == 151849) {
									showContainer('#breastfeeding-container-{n}');
									showContainer('#infant-birth-date-container-{n}');
									showContainer('#child-number-container-{n}');
									<!-- showContainer('#infant-arv-prophylaxis-container-{n}'); -->
									<!-- Don't show infant prophylaxis if negative test is selected for the mother -->
									if(getValue('hiv-test-result.value') == 664 || getValue('anc-retest-thirty-six-weeks.value') == 664)
										{hideContainer('#infant-arv-prophylaxis-container-{n}'); }else
										{showContainer('#infant-arv-prophylaxis-container-{n}');}
						
                                    hideContainer('#still-birth-container-{n}');
									hideContainer('#infant-death-date-container-{n}');
								} else {
									<!-- Baby died -->
									<!-- Still Birth -->
									if (getValue('infant-status-{n}.value') == 125872) {
										showContainer('#still-birth-container-{n}');
										hideContainer('#breastfeeding-container-{n}');
										hideContainer('#infant-arv-prophylaxis-container-{n}');
										hideContainer('#infant-death-date-container-{n}');
									} else if (getValue('infant-status-{n}.value') == 154223) { <!--neo-natal death -->
										hideContainer('#still-birth-container-{n}');
										showContainer('#breastfeeding-container-{n}');
										<!-- showContainer('#infant-arv-prophylaxis-container-{n}'); -->
										showContainer('#infant-death-date-container-{n}');
									}else {
										hideContainer('#still-birth-container-{n}');
										hideContainer('#breastfeeding-container-{n}');
										hideContainer('#infant-arv-prophylaxis-container-{n}');
										hideContainer('#infant-death-date-container-{n}');
									}
									
									hideContainer('#infant-birth-date-container-{n}');
									hideContainer('#child-number-container-{n}');
								}
							});
							jq('#infant_birth_date_{n}_missing').change(function(){
								handleMissingSelection('infant_birth_date_{n}');
							});
							jq('#child_number_{n}_missing').change(function(){
								handleMissingSelection('child_number_{n}');
							});
							jq('#infant_death_date_{n}_missing').change(function(){
								handleMissingSelection('infant_death_date_{n}');
							});
						});
					</script>
					<obsgroup groupingConceptId="8677{n}">
						<!-- TODO: Need to fix the layout of this table with the different options for mother death, HIV- status and baby died -->
						<table>
						<tbody>
							<tr>
								<td>
										<p id="infant-gender-container-{n}">
											<label>Sex</label>
											<obs id="infant-gender-{n}" style="radio" conceptId="1587AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerConceptIds="1535,1534" answerLabels="Female, Male" answerSeparator="" />
										</p>
								</td>
								<td>
									<p id="infant-birth-date-container-{n}" class="narrow">
										<label>Date of Birth</label>
										<obs id="infant_birth_date_{n}" conceptId="164802AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"/>
										<!-- <obs id="infant_birth_date_{n}_missing" conceptId="164943" style="checkbox" answerLabel="answerLabel" labelText="Infant date of birth missing"/>-->
									</p>
								</td>
							</tr>
							<tr>
								<td>
									<p id="infant-status-container-{n}">
										<label>
											Infant Status
										</label>
										<obs id="infant-status-{n}" style="radio" conceptId="159917AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerConceptIds="151849,154223,125872,164932"
											 answerLabels="Infant alive,Infant Died (Neonatal Death),Stillbirth, Missing" answerSeparator=""/>
									</p>
								</td>
								<td>
									<p id="breastfeeding-container-{n}" class="breastfeeding">
										<label>
											Infant Feeding at discharge
										</label>
										<obs id="breastfeeding-{n}" style="radio" conceptId="1151AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
											 answerConceptIds="5526,1595,164932"
											 answerLabels="EBF=Exclusive Breastfeeding, RF=Replacement feeding, Missing" answerSeparator=""/>
									</p>
                                    <p id="still-birth-container-{n}" class="hidden">
                                        <label>
                                            Type of still birth
                                        </label>
                                        <obs id="still-birth-{n}" style="radio" conceptId="125872AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
                                             answerConceptIds="159916,135436,164932"
                                             answerLabels="Fresh , Macerated, Missing" answerSeparator=""/>
                                    </p>
								</td>
							</tr>
							<tr>
								<td>
									<p id="infant-arv-prophylaxis-container-{n}" class="prophylaxis">
										<label>
											Infant Received ARV
										</label>
										<obs id="infant-arv-prophylaxis-{n}" style="radio" conceptId="1148AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerConceptIds="164918,127750,1754,164932"
											 answerLabels="ARV Prophylaxis daily up to 6 weeks, Refused ARV Prophylaxis,Stock-out of ARV Prophylaxis,Missing"
											 answerSeparator="" />
									</p>
									
								</td>
								<td>
									<p id="infant-death-date-container-{n}" class="hidden narrow">
										<label>Date of Death</label>
										<obs id="infant_death_date_{n}" conceptId="1543AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" />
										<obs id="infant_death_date_{n}_missing" conceptId="164947" style="checkbox" answerLabel="answerLabel" labelText="Date of Death missing"/>
									</p>
								</td>
							</tr>
							<tr id="child-number-container-{n}">
								<td>
									<p class="narrow">
										<label>Infant PTracker ID</label>
										<obs id="child_number_{n}" conceptId="164803AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" />
										<!--<obs id="child_number_{n}_missing" conceptId="164944" style="checkbox" answerLabel="answerLabel" labelText="Infant PTracker ID missing"/>-->
									</p>
								</td>
								<td></td>
							</tr>
						</tbody>
					</table>
					</obsgroup>
				</div>
			</template>
			<render n="1" />
			<render n="2" />
			<render n="3" />
			<render n="4" />
			<render n="5" />
			<render n="6" />
			<render n="7" />
			<render n="8" />
			<render n="9" />
		</repeat>
		</div>
	</section>
	<submit class="confirm center" />
</htmlform>