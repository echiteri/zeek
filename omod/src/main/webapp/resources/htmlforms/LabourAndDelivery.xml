<htmlform formName="Labour and Delivery Form"
		  formDescription="A visit for a mother for Labour and Delivery services"
		  formEncounterType="2678423c-0523-4d76-b0da-18177b439eed"
		  formUuid="1e5614d6-5306-11e6-beb8-9e71128cae77"
		  formVersion="0.9"
		  formAddMetadata="yes"
		  formUILocation="patientDashboard.overallActions"
		  formOrder="5"
		  formIcon="icon-medkit"
		  formShowIf="patient.person.dead==false &amp;&amp; patient.person.gender=='F' &amp;&amp; patient.person.age &gt; 12"
		  formDisplayStyle="Standard">

	<script type="text/javascript">
		jq(function() {
			<!--/* Show the current location and visit date while hiding the encounter location drop down and date picker for
			encounter date */-->
			jq('#encounterLocation').hide();
			jq('#currentLocation').text(jq('#encounterLocation select option:selected').text());
			jq('#visitDate').text(jq('#encounterDate input:nth-child(1)').val());
		
			beforeSubmit.push(function() {
				<!-- validation rules -->
				<!-- Breast feeding status only required if mother and baby are alive -->
				<!-- TODO: Add required checks for breast feeding status when the mother and baby are alive -->
				<!-- TODO: Add required check for infant propylaxis status if alive from birth -->
			});
		});
	</script>
	
	<style>
		#summary th {
			text-align: left;
			white-space: nowrap;
		}
	</style>
	<h2>
		<label>
			Labour and Delivery Form
		</label>
	</h2>
	<table id="who-when-where">
		<tbody>
			<tr>
				<td>
					<label>
						Attending Clinican
					</label>
					<encounterProvider default="currentUser" />
				</td>
				<td>
					<label>
						Health Facility
					</label>
					<span id="currentLocation"></span>
					<encounterLocation default="SessionAttribute:emrContext.sessionLocationId"
									   tags="1" /> <!-- Only show Login locations -->
				</td>
				<td>
					<label name="encounterDate">
						Visit Date
					</label>
					<encounterDate default="today" disallowMultipleEncountersOnDate="block" />
				</td>
			</tr>
		</tbody>
	</table>
	<section sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="Admission Information">
		<div class="section-container">
			<table id="summary">
				<tr>
					<th>Age (Yrs)</th>
					<th>Telephone Number</th>
					<th>No of ANC Visits</th>
				</tr>
				<tr>
					<td><lookup expression="patient.age"/></td>
					<td><lookup expression="personAttributes.get('Telephone Number')"/></td>
					<td><lookup	complexExpression="$fn.allEncounters('2549af50-75c8-4aeb-87ca-4bb2cef6c69a').size()"/></td>
				</tr>
				<includeIf velocityTest="$fn.allEncounters('2549af50-75c8-4aeb-87ca-4bb2cef6c69a').size() > 0">
				<tr>
					<th>HIV Status</th>
					<th>ART Status</th>
					<th>ART Number</th>
				</tr>
				<tr>
					<td>
						
					<!-- Start with Previously known Positive -->
					<includeIf velocityTest="$fn.latestObs('159803AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 1169">
						Previously Known Positive
					</includeIf>
					<includeIf velocityTest="$fn.latestObs('161558AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 1065">
						<lookup	complexExpression="$fn.latestObs('1396AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.name"/> on <lookup	complexExpression="$fn.latestObs('1396AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').obsDatetime"/>
					</includeIf>
					</td>
					<td>
						<lookup	expression="$fn.latestObs('160117AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.name"/>
					</td>
					<td><lookup	expression="patient.getPatientIdentifier('ART Unique Number')"/></td>
				</tr>
				<tr>
					<th>Last ANC Visit Date</th>
					<th>Referral ANC Clinic</th>
					<th>ANC Provider Name</th>
				</tr>
				<tr>
					<td><lookup	complexExpression="$fn.latestEncounter('2549af50-75c8-4aeb-87ca-4bb2cef6c69a').encounterDatetime"/></td>
					<td><lookup	complexExpression="$fn.latestEncounter('2549af50-75c8-4aeb-87ca-4bb2cef6c69a').location.name" /></td>
					<td>
						<lookup	complexExpression="#foreach($encounterProvider in $fn.latestEncounter('2549af50-75c8-4aeb-87ca-4bb2cef6c69a').encounterProviders) $encounterProvider.provider.person.personName #end" />
						
					</td>
				</tr>
				</includeIf>
			</table>
		</div>
	</section>
	<section sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="Delivery Information">
		<div class="section-container">
			<includeIf velocityTest="$fn.allEncounters('2549af50-75c8-4aeb-87ca-4bb2cef6c69a').size() &lt;1">
			<p>
				<obs style="checkbox" conceptId="1246AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" required="true"  labelText="Was this client booked at ANC?" />
				<!--<p>
					<label>
						Was this client booked at ANC?
					</label>
					<obs style="radio" conceptId="1246AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerSeparator=""  required="true" answerConceptIds="1065,1066,1067" answerLabels="Yes, No, Unknown"/>
				</p> -->
			</p>
			<p>
				<label>
					Does the client have a pink book?
				</label>
				<obs style="radio"  conceptId="1719AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerSeparator=""  required="true" answerConceptIds="1065,1066,1067" answerLabels="Yes, No, Unknown"/>
			</p>
			</includeIf>
			<p id="pregnancy-number-container" class="narrow">
				<label>
					PTracker Pregnancy Number
				</label>
				<obs conceptId="161655AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" />
			</p>
		</div>
	</section>
	<!--
	Show the HIV testing questions if
	- No HIV Test was done during antenatal
	- Not tested because of test kit stockout
	- TODO: Add a test when the last test was negative, and its more than 3 months since that test
	-->
	<includeIf velocityTest="!$fn.latestObs('161558AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA') ">
			
	<section sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="HIV Status at Delivery">
		<script>
			jq(function() {
				<!-- Whether the client has been tested -->
				jq('#hiv-test').click(function(){
					if(getValue('hiv-test.value') == 1065) {
						showContainer('#hiv-test-result-container');
						hideContainer('#not-tested-container');
						hideContainer('#refused-test-reason-container');
						hideContainer('#art-status-container');
						hideContainer('#art-number-container');
						hideContainer('#art-startdate-container');
						hideContainer('#art-initiation-container');
						hideContainer('#refused-art-container');
					} else {
						hideContainer('#hiv-test-result-container');
						showContainer('#not-tested-container');
						hideContainer('#refused-test-reason-container');
						hideContainer('#art-status-container');
						hideContainer('#art-number-container');
						hideContainer('#art-startdate-container');
						hideContainer('#art-initiation-container');
						hideContainer('#refused-art-container');
					}
				});
				<!-- reason for not testing -->
				jq('#not-tested').click(function(){
					if(getValue('not-tested.value') == 128453) {
						showContainer('#refused-test-reason-container');
					} else if (getValue('not-tested.value') == 1169) {
						<!-- previously known positive -->
						showContainer('#art-status-container');
						hideContainer('#refused-test-reason-container');
						hideContainer('#art-initiatin-container');
					} else {
						hideContainer('#refused-test-reason-container');
						hideContainer('#art-initiatin-container');
					}
				});
				<!-- ART Status -->
				jq('#art-status').click(function(){
					if (getValue('art-status.value') == 'true') {
						<!-- Already on ART -->
						showContainer('#art-number-container');
						showContainer('#art-startdate-container');
						<!-- Enusre ART start date is empty -->
						setValue('art-start-date.value', '');
						hideContainer('#art-initiation-container');
					} else {
						<!-- Not yet on ART so initialize -->
						hideContainer('#art-number-container');
						hideContainer('#art-startdate-container');
						showContainer('#art-initiation-container');
					}
				});
				jq('#hiv-test-result').click(function(){
					if(getValue('hiv-test-result.value') == 703) {
						<!-- positive result -->
						showContainer('#art-initiation-container');
						showContainer('#art-number-container');
					} else {
						hideContainer('#art-initiation-container');
						hideContainer('#art-number-container');
					}
				});
				jq('#art-initiation').click(function(){
					if(getValue('art-initiation.value') == 160120) {
						showContainer('#art-number-container');
						hideContainer('#refused-art-container');
						<!-- set ART start date to today -->
						setValue('art-start-date.value', jq.datepicker.formatDate('yy-mm-dd', new Date()));
					} else if (getValue('art-initiation.value') == 160018) {
						<!-- refused ART -->
						showContainer('#refused-art-container');
						hideContainer('#art-number-container');
						setValue('art-start-date.value', '');
					} else {
						hideContainer('#refused-art-container');
						hideContainer('#art-number-container');
						setValue('art-start-date.value', '');
					}
				});
			});
		</script>
		<div class="section-container">
			<!-- Do not show the testing if
				- client is previously known positive
				- client refused test
				- client tested and test was positive or negative
			-->
			
			
			<p id="hiv-test-container" class="">
				<label>
					HIV Test Status
				</label>
				<obs id="hiv-test" style="radio" conceptId="161558AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
					 answerConceptIds="1065,1066,1067"
					 answerLabels="Tested for HIV during this visit,Not tested for HIV during this visit, Unknown" answerSeparator="" required="true" />
			</p>
			<p id="not-tested-container" class="hidden">
				<label>
					Reason for not testing
				</label>
				<obs id="not-tested" style="radio" conceptId="159803AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
					 answerConceptIds="1169,160352,128453"
					 answerLabels="Previously known positive, Testing kit stockout, Refused test" answerSeparator="" />
			</p>
			<p id="refused-test-reason-container" class="hidden">
				<label>
					Reason for refusing test
				</label>
				<obs conceptId="160632AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"/>
			</p>
			<p id="hiv-test-result-container" class="hidden">
				<label>
					HIV Test Result
				</label>
				<obs id="hiv-test-result" style="radio" conceptId="1396AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerConceptIds="664,703,1067"
					 answerLabels="Negative,Positive,Unknown"
					 answerSeparator="" />
			</p>
			<p id="art-status-container" class="hidden" >
				<label>
					Already on ART treatment?
				</label>
				<obs id="art-status" conceptId="1662AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerSeparator="" style="yes_no"/>
			</p>
			<p id="art-initiation-container" class="hidden">
			<label>
				ART initiation
			</label>
				<obs id="art-initiation" style="radio" conceptId="160117AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
					 answerConceptIds="160120,160018,1754,1067"
					 answerLabels="Started ART during this visit,Refused ART,Not started due to stockout,Unknown" answerSeparator="" />
			</p>
			<p id="art-number-container" class="hidden narrow">
					<label>ART Unique Number</label>
					<patient id="art-number" field="identifier" identifierTypeId="9d6d1eec-2cd6-4637-a981-4a46b4b8b41f"  required="false" />
			</p>
			<p id="refused-art-container" class="hidden">
				<label>Reason for refusing ART initiation</label>
				<obs id="refused-art" conceptId="163322AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" />
			</p>
			<p id="art-startdate-container" class="hidden narrow">
				<label>ART start date</label>
				<obs id="art-start-date" conceptId="159599AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" />
				<script>
					jq(function(){
						jq('#art-start-date :input[type=text]').change(function(){
							
							var art_start_date = getValue('art-start-date.value');
							var visit_date = getValue('encounterDate.value');
							
							if (art_start_date != '') {
								<!-- check that the ART start date is not after the visit date -->
								if (art_start_date &gt; visit_date) {
									alert('The ART start date cannot be after the date of this visit ' +  changeFieldDateToJavascriptDate(visit_date));
								} else {
									var diff = Math.abs(new Date(changeFieldDateToJavascriptDate(visit_date)) - new Date(changeFieldDateToJavascriptDate(art_start_date)));
								}
							}
						});
					});
				</script>
				
			</p>
		</div>
	</section>
	</includeIf>
	<section sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="Mother and Infant Status">
	<div class="section-container">
		<script>
			jq(function(){
			var babies = 0;
				jq('#birth-count').click(function(){
					babies = getValue('birth-count.value');
					for (i=0; i &lt; 10; i++) {
						if (i &lt; babies) {
							showContainer('#' + (i +1) + '-toggleContainer');
						} else {
							<!-- hide the rest of the containers just in case a higher number was selected before -->
							hideContainer('#' + (i +1) + '-toggleContainer');
						}
					}
				});
				jq(function(){
					jq('#mother-status').click(function(){
						<!-- Hide breast feeding status if the mother died -->
						if (getValue('mother-status.value') == 160034) {
							for (i=0; i &lt; 10; i++) {
								hideContainer('#breastfeeding-container-' + i );
							}
						} else {
							for (i=0; i &lt; 10; i++) {
								if (getValue('infant-status-' + i + '.value') == '' || getValue('infant-status-' + i + '.value') == 151849) {
									showContainer('#breastfeeding-container-' + 1);
								}
							}
							
						}
					});
				});
			});
		</script>
		<p>
			<label>
				Mother's status
			</label>
			<obs id="mother-status" style="radio" conceptId="1856AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerConceptIds="161636,160034,159492,1067"
				 answerLabels="Still in Care,Mother Died (Maternal Death),Transferred Out, Unknown" answerSeparator="" required="true"/>
		</p>
		<p>
			<label>Number of babies born from this pregnancy</label>
			<obs id="birth-count" conceptId="1568AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" required="true" answers="1,2,3,4,5,6,7,8,9" answerLabels="1,2,3,4,5,6,7,8,9"/>
		</p>
		
		
		
		<repeat>
			<template>
				<div id="{n}-toggleContainer" class="hidden">
					<h3>Child # {n}</h3>
					<script>
						jq(function(){
						
							jq('#infant-status-{n}').click(function(){
								<!-- hide breast feeding and prophylaxis status if baby died -->
								if (getValue('infant-status-{n}.value') == 151849) {
									showContainer('#breastfeeding-container-{n}');
									showContainer('#infant-arv-prophylaxis-container-{n}');
									showContainer('#infant-birth-date-{n}');
									hideContainer('#infant-death-date-container-{n}');
								} else {
									hideContainer('#breastfeeding-container-{n}');
									hideContainer('#infant-arv-prophylaxis-container-{n}');
									showContainer('#infant-death-date-container-{n}');
									hideContainer('#infant-birth-date-{n}');
								}
							});
						});
					</script>
					<table>
						<tbody>
							<tr>
								<td>
										<p>
											<label>Gender</label>
											<patient field="gender" />
										</p>
								</td>
								<td>
									<p id="infant-birth-date-{n}" class="narrow">
										<label>Date of Birth</label>
										<patient field="birthDate" />
									</p>
								</td>
							</tr>
							<tr>
								<td>
									<p id="infant-status-container-{n}">
										<label>
											Infant Status
										</label>
										<obs id="infant-status-{n}" style="radio" conceptId="159917AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerConceptIds="151849,154223,125872"
											 answerLabels="Infant alive,Infant Died (Neonatal Death),Still Birth" answerSeparator=""/>
									</p>
								</td>
								<td>
									<p id="breastfeeding-container-{n}">
										<label>
											Breastfeeding Status
										</label>
										<obs style="radio" conceptId="1151AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
											 answerConceptIds="5526,1595"
											 answerLabels="Exclusive Breastfeeding, Replacement feeding" answerSeparator=""/>
									</p>
								</td>
							</tr>
							<tr>
								<td>
									<p id="infant-arv-prophylaxis-container-{n}">
										<label>
											Infant Recieved ARV
										</label>
										<obs style="radio" conceptId="1148AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerConceptIds="1065,127750,1754"
											 answerLabels="ARV Prohylaxis daily up to 6 weeks, Refused ARV Prophylaxis,Stock-out of ARV Prophylaxis"
											 answerSeparator="" />
									</p>
								</td>
								<td>
									<p id="infant-death-date-container-{n}" class="hidden">
										<label>Date of Death</label>
										<obs id="infant-death-date-{n}" conceptId="1543AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" />
									</p>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			</template>
				<render n="1" />
				<render n="2" />
				<render n="3" />
				<render n="4" />
				<render n="5" />
				<render n="6" />
				<render n="7" />
				<render n="8" />
				<render n="9" />
		</repeat>
				
		
			
		</div>
	</section>
	<section sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="Post Natal Followup">
		<div class="section-container">
			<p id="expected-post-natal-facility">
				<label>
					Expected post natal care facility
				</label>
				<obs id="pnc-facility" conceptId="162724AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" style="location" answerLocationTags="2"/>
			</p>
		</div>
	</section>
	<submit class="confirm center" />
</htmlform>