<htmlform formName="Antenatal Form"
		  formDescription="A visit for a mother for ANC services"
		  formEncounterType="2549af50-75c8-4aeb-87ca-4bb2cef6c69a"
		  formUuid="12de5bc5-352e-4faf-9961-a2125085a75c"
		  formVersion="0.9"
		  formAddMetadata="yes"
		  formUILocation="patientDashboard.overallActions"
		  formOrder="1"
		  formIcon="icon-medkit"
		  formShowIf="patient.person.dead==false &amp;&amp; patient.person.gender=='F' &amp;&amp; patient.person.age &gt; 12"
		  formDisplayStyle="Standard">
	<script>
		jq(function() {
			<!-- Set the id value of the followup container from the class since the section tag does not have an id attribute-->
			jq('.followup-container').attr('id', 'followup-container');
		
			<!-- Show the current location and visit date while hiding the encounter location drop down and date picker for
			encounter date -->
			jq('#encounterLocation').hide();
			jq('#currentLocation').text(jq('#encounterLocation select option:selected').text());
		
			<!-- EDD computation -->
			jq('#lmp :input[type=text]').change(function(){
				jq('#edd').text(calculateEDD(getValue('lmp.value')));
			});
		
			beforeSubmit.push(function() {
				<!-- validation rules for Pregancy information -->
				<!-- clear the previous errors -->
				if (getField('para.value') != null) {
					setValue('para.error', '');
					setValue('lmp.error', '');
					
					var para = getValue('para.value');
					var gravida = getValue('gravida.value');
					<!-- the gravida must always be greater than or equal to para -->
					if (gravida &lt; para) {
						getField('para.error').html('The number of babies delivered (para) must be greater than the number of pregnancies (gravida)').show();
						return false;
					}
					
					<!-- LNMP must be before the encounter date -->
					var lmpDate = new Date(changeFieldDateToJavascriptDate(getValue('lmp.value')));
					var encounterDate = new Date(changeFieldDateToJavascriptDate(getValue('encounterDate.value')));
					if (encounterDate &lt; lmpDate) {
						getField('lmp.error').html('The date of the last menstral period must be before the visit date ' +
		encounterDate).show();
						return false;
					}
			
					<!-- The LMP date cannot be more than 36 weeks before the visit date for ANC -->
					if (Math.abs(encounterDate - lmpDate)/(1000 * 86400 * 7) > 35) {
						getField('lmp.error').html('The date of the last menstral period cannot be more than 36 weeks before the visit date ' + encounterDate).show();
						return false;
					}
				}
		
				<!-- Validation rules for Testing and Initiation -->
				<!-- clear the previous errors -->
				setValue('hiv-test-result.error', '');
				
				<!-- if there is a test the test result is required -->
				if (getValue('hiv-test.value') == 1065) {
					var test_result = getValue('hiv-test-result.value');
					if ((test_result == null) || (test_result = '')) {
						getField('hiv-test-result.error').html('The results for the HIV test must be provided').show();
						return false;
					}
				}
		
				<!-- Validation rules for follow up -->
				setValue('transfer-out-to.error', '');
				setValue('next-visit-date.error', '');
				<!-- check the date of the next visit -->
				var next_visit_date = new Date(changeFieldDateToJavascriptDate(getValue('next-visit-date.value')));
				
				<!-- next visit date must be after the current visit date -->
				if (encounterDate &gt; next_visit_date) {
					getField('next-visit-date.error').html('The date of the next visit ' + 'must be after ' + encounterDate + ' the date of this visit').show();
					return false;
				}
			
				<!-- also check that the next visit is not after the expected date of delivery -->
				var edd = new Date(jq('#edd').text());
				if (next_visit_date &gt; edd) {
					getField('next-visit-date.error').html('The date of the next visit cannot be after the expected delivery date of ' + edd).show();
					return false;
				}
		
				if (!jq('#transfer-out-to-container').hasClass('hidden')) {
					<!-- the transfer  out location is required -->
					if (getValue('transfer-out-to.value') == '') {
						getField('transfer-out-to.error').html('Please enter the facility to which the patient is to transfer to').show();
						return false;
					}
				}
		
				return true;
			});
		});
		
		<!--Function to calculate EDD-->
		function calculateEDD(lmp){
			if (!lmp.trim()) {
				return "";
			}
			
			<!--Based on (((lmp + 1 year)-3 months) + 7 days) algorithm-->
			var lmpDate = new Date(lmp);
			lmpDate.setYear(lmpDate.getFullYear() + 1);
			lmpDate.setMonth(lmpDate.getMonth() - 3);
			lmpDate.setDate(lmpDate.getDate() + 7);
			var mm = lmpDate.getMonth() + 1;
			var dd = lmpDate.getDate();
			var yyyy = lmpDate.getFullYear();
			mm = (mm &lt; 10) ? '0' + mm : mm;
			dd = (dd &lt; 10) ? '0' + dd : dd;
			
			var date = mm + '/' + dd + '/' + yyyy;
			return date;
		}
	</script>
	<h2>
		<label>
			Mother ANC Visit
		</label>
	</h2>
	<table id="who-when-where">
		<tbody>
			<tr>
				<td>
					<label>
						Attending Clinican
					</label>
					<encounterProvider default="currentUser" />
				</td>
				<td>
					<label>
						Health Facility
					</label>
					<span id="currentLocation"></span>
					<encounterLocation default="SessionAttribute:emrContext.sessionLocationId"
									   tags="1" /> <!-- Only show Login locations -->
				</td>
				<td>
					<label name="encounterDate">
						Visit Date
					</label>
					<encounterDate default="today" disallowMultipleEncountersOnDate="block" />
				</td>
			</tr>
		</tbody>
	</table>
	<includeIf velocityTest="$fn.allEncounters('2549af50-75c8-4aeb-87ca-4bb2cef6c69a').size() == 0">
		<section sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="Details of Pregnancy">
			<div class="section-container">
				<p>
					<label>
						How many times have you been pregnant, including current pregnancy (Gravida)?
					</label>
					<p class="narrow">
						<obs id="gravida" conceptId="5624AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" required="true" />
					</p>
				</p>
				<p>
					<label>
						How many babies have you delivered before (Para)?
					</label>
					<p class="narrow">
						<obs id="para" conceptId="1053AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" required="true" />
					</p>
				</p>
				
				<p>
					<label>
						Date of last known menstural period (LNMP)
					</label>
					<p class="narrow">
						<obs conceptId="1427AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" id="lmp" required="true" />
					</p>
				</p>
				<p>
					<label>Estimated date of delivery (EDD)</label>
					<span id="edd" class="standout" style="margin-left: 10px;"></span>
				</p>
				<p class="narrow">
					<label>
						Expected facility of delivery
					</label>
					<obs required="true" conceptId="162724AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" style="location" answerLocationTags="Delivery Location" /> <!--only show delivery locations -->
				</p>
			</div>
		</section>
	</includeIf>
	<includeIf velocityTest="$fn.allEncounters('2549af50-75c8-4aeb-87ca-4bb2cef6c69a').size() > 0">
		<!-- Subsequent ANC visit -->
		<!-- TODO: Need to find a way of checking that this encounter is after the EDD so that multiple pregancies are handled -->
		<section sectionTag="fieldset" headerTag="legend" headerStyle="title summary" headerCode="First ANC Visit Summary Information">
			<script>
				jq(function() {
					<!-- change the label of the legend for this section since its nolonger the first ANC visit -->
					jq('legend.summary').html('ANC Visit Summary Information');
					<!-- Show the EDD -->
					jq('#edd').text(calculateEDD(jq('#lmp').text()));
				});
			</script>
			<div class="section-container">
				<table>
					<tr>
						<th align="left">Age (Years)</th>
						<th colspan="2" align="left" width="60%">Telephone Number</th>
					</tr>
					<tr>
						<td><lookup expression="patient.age"/></td>
						<td colspan="2" width="60%"><lookup expression="personAttributes.get('Telephone Number')"/></td>
					</tr>
						<tr>
							<th align="left" width="40%">Date of Last Known Menstral Period (LNMP)</th>
							<th align="left" width="30%">Expected Date of Delivery (EDD)</th>
							<th align="left">Expected Facility of Delivery</th>
						</tr>
						<tr>
							<td><span id="lmp"><lookup expression="fn.latestObs('1427AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueDatetime" /></span></td>
							<td><span id="edd"></span></td>
							<td>
								<lookup complexExpression="$fn.location($fn.latestObs('162724AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueText).name" />
							</td>
						
						</tr>
						
						<includeIf velocityTest="$fn.latestObs('161558AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 1065">
							<tr>
								<th align="left">Last HIV Status</th>
								<th align="left">Date of last HIV Test
								</th>
								<th>ART Initiation Status</th>
							</tr>
							<tr>
								<td><lookup	complexExpression="$fn.latestObs('1396AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.name" /></td>
								<td><lookup	complexExpression="$fn.latestObs('1396AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').obsDatetime" /></td>
								<td><lookup	complexExpression="$fn.latestObs('160117AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.name" /></td>
							</tr>
						</includeIf>
						<includeIf velocityTest="$fn.latestObs('161558AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 1066">
							<tr>
								<th align="left">Last HIV Status</th>
								<th colspan="2" align="left">Reason for Not Testing
								</th>
							</tr>
							<tr>
								<td>Not Tested</td>
								<td colspan="2">
									<includeIf velocityTest="$fn.latestObs('159803AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 1169">
										Previously known positive
									
									</includeIf>
									<includeIf velocityTest="$fn.latestObs('159803AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 160352">
										Testing kit stockout
									
									</includeIf>
									<includeIf velocityTest="$fn.latestObs('159803AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 128453">
										Refused Test : <lookup	complexExpression="#set($refuse_reason = $fn.latestObs('160632AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueText) $!{refuse_reason}" />
									
									</includeIf>
								</td>
							</tr>
						</includeIf>
						<tr>
							<th align="left" width="40%">Previous ANC Visits</th>
							<th align="left" width="30%">Last ANC Clinic</th>
							<th align="left">Last ANC Provider</th>
						</tr>
						<tr>
							<td><lookup	complexExpression="$fn.allEncounters('2549af50-75c8-4aeb-87ca-4bb2cef6c69a').size()"/></td>
							<td><lookup	complexExpression="$fn.latestEncounter('2549af50-75c8-4aeb-87ca-4bb2cef6c69a').location.name" /></td>
							<td>
								
							</td>
						</tr>
					</table>
			</div>
		</section>
		
	</includeIf>
	<section sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="HIV Testing and ART Initiation">
		<script>
			jq(function() {
				<!-- Whether the client has been tested -->
				jq('#hiv-test').click(function(){
					if(getValue('hiv-test.value') == 1065) {
						showContainer('#hiv-test-result-container');
						hideContainer('#not-tested-container');
						hideContainer('#refused-test-reason-container');
						hideContainer('#art-status-container');
						hideContainer('#art-number-container');
						hideContainer('#art-startdate-container');
						hideContainer('#art-initiation-container');
						hideContainer('#refused-art-container');
					} else {
						hideContainer('#hiv-test-result-container');
						showContainer('#not-tested-container');
						hideContainer('#refused-test-reason-container');
						hideContainer('#art-status-container');
						hideContainer('#art-number-container');
						hideContainer('#art-startdate-container');
						hideContainer('#art-initiation-container');
						hideContainer('#refused-art-container');
					}
				});
				<!-- reason for not testing -->
				jq('#not-tested').click(function(){
					if(getValue('not-tested.value') == 128453) {
						showContainer('#refused-test-reason-container');
					} else if (getValue('not-tested.value') == 1169) {
						<!-- previously known positive -->
						showContainer('#art-status-container');
						hideContainer('#refused-test-reason-container');
						hideContainer('#art-initiatin-container');
					} else {
						hideContainer('#refused-test-reason-container');
						hideContainer('#art-initiatin-container');
					}
				});
				<!-- ART Status -->
				jq('#art-status').click(function(){
					if (getValue('art-status.value') == 'true') {
						<!-- Already on ART -->
						showContainer('#art-number-container');
						showContainer('#art-startdate-container');
						<!-- Enusre ART start date is empty -->
						setValue('art-start-date.value', '');
						hideContainer('#art-initiation-container');
					} else {
						<!-- Not yet on ART so initialize -->
						hideContainer('#art-number-container');
						hideContainer('#art-startdate-container');
						showContainer('#art-initiation-container');
					}
				});
				jq('#hiv-test-result').click(function(){
					if(getValue('hiv-test-result.value') == 703) {
						<!-- positive result -->
						showContainer('#art-initiation-container');
						showContainer('#art-number-container');
					} else {
						hideContainer('#art-initiation-container');
						hideContainer('#art-number-container');
					}
				});
				jq('#art-initiation').click(function(){
					if(getValue('art-initiation.value') == 160120) {
						showContainer('#art-number-container');
						hideContainer('#refused-art-container');
						<!-- set ART start date to today -->
						setValue('art-start-date.value', jq.datepicker.formatDate('yy-mm-dd', new Date()));
					} else if (getValue('art-initiation.value') == 160018) {
						<!-- refused ART -->
						showContainer('#refused-art-container');
						hideContainer('#art-number-container');
						setValue('art-start-date.value', '');
					} else {
						hideContainer('#refused-art-container');
						hideContainer('#art-number-container');
						setValue('art-start-date.value', '');
					}
				});
			});
		</script>
		<div class="section-container">
			<includeIf velocityTest="$fn.latestObs('159803AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 1169 || $fn.latestObs('1396AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 703">
				<includeIf velocityTest="$fn.latestObs('1662AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId != 1065">
					<!-- Show ART Status container if the client is a previously known positive, has been tested with positive but not yet initiated on ART -->
					<script>
						jq(function() {
							showContainer('#art-initiation-container');
						});
					</script>
				</includeIf>
			</includeIf>
			<!-- Do not show ART testing if previously known positive, tested positive -->
			<excludeIf velocityTest="$fn.latestObs('1396AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 703 || $fn.latestObs('159803AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA').valueCoded.conceptId == 1169">
				<p id="hiv-test-container">
					<label>
						HIV test status
					</label>
					<obs id="hiv-test" style="radio" conceptId="161558AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
						 answerConceptIds="1065,1066"
						 answerLabels="Tested for HIV during this visit,Not tested for HIV during this visit" answerSeparator="" required="true" />
				</p>
				<p id="not-tested-container" class="hidden">
					<label>
						Reason for not testing
					</label>
					<obs id="not-tested" style="radio" conceptId="159803AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
						 answerConceptIds="1169,160352,128453"
						 answerLabels="Previously known positive, Testing kit stockout, Refused test" answerSeparator="" />
				</p>
				<p id="refused-test-reason-container" class="hidden">
					<label>
						Reason for refusing test
					</label>
					<obs conceptId="160632AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"/>
				</p>
			</excludeIf>
			
			<p id="hiv-test-result-container" class="hidden">
				<label>
					HIV test result
				</label>
				<obs id="hiv-test-result" style="radio" conceptId="1396AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerConceptIds="664,703,1067"
					 answerLabels="Negative,Positive,Unknown"
					 answerSeparator="" />
			</p>
				
			<p id="art-status-container" class="hidden" >
				<label>
					Already on ART treatment?
				</label>
				<obs id="art-status" conceptId="1662AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerSeparator="" style="yes_no"/>
			</p>
			<p id="art-initiation-container" class="hidden">
			<label>
				ART initiation
			</label>
				<obs id="art-initiation" style="radio" conceptId="160117AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
					 answerConceptIds="160120,160018,1754,1067"
					 answerLabels="Started ART during this visit,Refused ART,Not started due to stockout,Unknown" answerSeparator="" />
			</p>
			<p id="art-number-container" class="hidden narrow">
					<label>ART Unique Number</label>
					<patient id="art-number" field="identifier" identifierTypeId="9d6d1eec-2cd6-4637-a981-4a46b4b8b41f"  required="false" />
			</p>
			<p id="refused-art-container" class="hidden">
				<label>Reason for refusing ART initiation</label>
				<obs id="refused-art" conceptId="163322AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" />
			</p>
			<p id="art-startdate-container" class="hidden narrow">
				<label>ART start date</label>
				<obs id="art-start-date" conceptId="159599AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" />
				<script>
					jq(function(){
						jq('#art-start-date :input[type=text]').change(function(){
							
							var art_start_date = getValue('art-start-date.value');
							var visit_date = getValue('encounterDate.value');
							
							if (art_start_date != '') {
								<!-- check that the ART start date is not after the visit date -->
								if (art_start_date &gt; visit_date) {
									alert('The ART start date cannot be after the date of this visit ' +  changeFieldDateToJavascriptDate(visit_date));
								} else {
									var diff = Math.abs(new Date(changeFieldDateToJavascriptDate(visit_date)) - new Date(changeFieldDateToJavascriptDate(art_start_date)));
									<!-- Show the viral load container if the ART start date is more than 6 months before today -->
									var months = Math.round(diff/(86400000 * 30));
									if (months > 6) {
										showContainer('#recent-viral-load-container');
									}
								}
							}
						});
					});
				</script>
				
			</p>
				<p id="recent-viral-load-container" class="">
					<label>
						Has the patient had a recent viral load test? 					</label>
					<obs style="radio" conceptId="163310AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" id="recent-viral-load" answerConceptIds="1267, 1118, 1067"
						 answerLabels="Yes, No, Unknown"
						 answerSeparator="" />
					<script>
						jq(function() {
							jq('#recent-viral-load').click(function(){
								if (getValue('recent-viral-load.value') == 1267) {
									showContainer('#viral-load-results-container');
									showContainer('#viral-load-test-date-container');
									hideContainer('#viral-load-copies-container');
								} else {
									hideContainer('#viral-load-results-container');
									hideContainer('#viral-load-test-date-container');
									hideContainer('#viral-load-copies-container');
								}
							});
						});
					</script>
					
				</p>
			
				<!-- TODO: Add handling for the second viral load result -->
			<p id="viral-load-test-date-container" class="narrow hidden">
				<label>Viral load test date</label>
				<obs conceptId="163281" id="viral-load-test-date"/>
			</p>
			<p id="viral-load-results-container" class="hidden">
				<label>Viral load results</label>
				<obs id="viral-load-results" conceptId="1305AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerConceptIds="1301,1306,1304" style="radio"
					 answerSeparator=""
					 answerLabels="Target Detected,Not Detected, Sample Rejected"/>
				<script>
						jq(function() {
							jq('#viral-load-results').click(function(){
								if (getValue('viral-load-results.value') == 1301) {
									showContainer('#viral-load-copies-container');
								} else {
									hideContainer('#viral-load-copies-container');
								}
							});
						});
					</script>
			</p><br/>
			<p id="viral-load-copies-container" class="narrow hidden">
				<label>Viral load</label>
				
				<obs id="viral-load-copies" showUnits="copies/ml" unitsCssClass="append-to-value" conceptId="856AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"/>
			
			</p>
		</div>
	</section>
	<section sectionTag="fieldset" headerTag="legend" headerStyle="title" headerCode="Followup" sectionStyle="followup-container">
		<script>
			jq(function() {
				jq('#transfer-out').click(function(){
					if (getValue('transfer-out.value') == 1065) {
						showContainer('#transfer-out-to-container');
					} else {
						hideContainer('#transfer-out-to-container');
					}
				});
			});
		</script>
		<div class="section-container">
			<p id="next-visit-date-container" class="narrow">
				<label>Next Visit Date</label>
				<obs id="next-visit-date" conceptId="5096AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" allowFutureDates="true" required="true" />
			</p>
			<p id="transfer-out-container">
				<label>Facility of next appointment</label>
				<obs id="transfer-out" style="radio" conceptId="1285AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" answerConceptIds="1066,1065" answerLabels="This facility,Transfer" answerSeparator="" required="true"  />
			</p>
			<p id="transfer-out-to-container" class="hidden">
				<label>Transfer to</label>
				<obs id="transfer-out-to" conceptId="159495AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA" style="location" answerLocationTags="2" />
			</p>
		</div>
	</section><br />
	<submit class="confirm center" />
</htmlform>