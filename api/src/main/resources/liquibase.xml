<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
				   xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
				   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
                  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">
	<!--
		See http://www.liquibase.org/manual/home#available_database_refactorings
		for a list of supported elements and attributes
	-->
	<changeSet id="namibia-05092017-0036" author="ssmusoke">
		<comment>Rename concept names to match the forms</comment>
		<sql>
			# Concept renaming
			# 164180 to New ANC Visit
			UPDATE concept_name SET name = 'New ANC Visit' WHERE concept_name_id = 140083;
			# 160530 to Return ANC Visit
			UPDATE concept_name SET name = 'Return ANC Visit' WHERE concept_name_id = 108840;
			# 160119 to Already on ART
			UPDATE concept_name SET name = 'Already on ART' WHERE concept_name_id = 107851;
			# 160120 to Initiated on ART
			UPDATE concept_name SET name = 'Taking Inititated ARVs' WHERE concept_name_id = 107853;
			# 160018 to Refused ART
			UPDATE concept_name SET name = 'Refused ART' WHERE concept_name_id = 107643;
			# 163310 from HIV Viral Load Status to Viral Load Test Done
			UPDATE concept_name SET name = 'Viral Load Test Done' WHERE concept_name_id = 135870;
			# 1305 to Viral Load Results
			UPDATE concept_name SET name = 'Viral Load Results' WHERE concept_name_id = 1392;
			# 1301 to Target Detected
			UPDATE concept_name SET name = 'Target Detected' WHERE concept_name_id = 1388;
			# 1306 to Not Detected
			UPDATE concept_name SET name = 'Not Detected' WHERE concept_name_id = 1395;
			# 1304 to Sample Rejected
			UPDATE concept_name SET name = 'Sample Rejected' WHERE concept_name_id = 1391;
			# 159971 to Results Pending
			UPDATE concept_name SET name = 'Results Pending' WHERE concept_name_id = 107532;
			# 161636 from Active Status to Still in Care
			UPDATE concept_name SET name = 'Still in Care' WHERE concept_name_id = 123622;
			# 1641 from Discharge Date-Time to Discharge Date
			UPDATE concept_name SET name = 'Discharge Date' WHERE concept_name_id = 1921;
			# 1658 from ANTIRETROVIRAL ADHERENCE IN PAST MONTH to ARV Adherence
			UPDATE concept_name SET name = 'ARV Adherence' WHERE concept_name_id = 1938;
			# 1256 from START DRUGS to Staring Prophylaxis on this visit
			UPDATE concept_name SET name = 'Starting Propylaxis on this visit' WHERE concept_name_id = 1335;
			# 1042 from HIV ENZYME IMMUNOASSAY, QUALITATIVE to Rapid Test
			UPDATE concept_name SET name = 'Rapid Test' WHERE concept_name_id = 1099;
			# 1754 from Medications Unavailable to Stockout
			UPDATE concept_name SET name = 'Stock Out' WHERE concept_name_id = 2034;
			# 1148 rename from TOTAL MATERNAL TO CHILD TRANSMISSION PROPHYLAXIS to ARV Prophylaxis Status
			UPDATE concept_name SET name = 'ARV Prophylaxis Status' WHERE concept_name_id = 1224;
			
			# Change the default name of the concept i.e., the FULLY QUALIFIED NAME
			# 5596 from Estimated date of confinement to Estimated date of delivery
			UPDATE concept_name SET concept_name_type = NULL, locale_preferred = 0 WHERE concept_name_id = 2732;
			UPDATE concept_name SET concept_name_type = 'FULLY_SPECIFIED', locale_preferred = 1 WHERE concept_name_id = 91593;
			# 159599 from Antiretrovial treatment start date to ART Start Date
			UPDATE concept_name SET concept_name_type = NULL, locale_preferred = 0 WHERE concept_name_id = 106945;
			UPDATE concept_name SET concept_name_type = 'FULLY_SPECIFIED', locale_preferred = 1 WHERE concept_name_id = 107886;
			# 856 from HIV Viral Load to Viral Load
			UPDATE concept_name SET concept_name_type = NULL, locale_preferred = 0 WHERE concept_name_id = 898;
			UPDATE concept_name SET concept_name_type = 'FULLY_SPECIFIED', locale_preferred = 1 WHERE concept_name_id =100036;
			# 151849 from Liveborn, Unspecified Whether Single, Twin or Muliple to Liveborn
			UPDATE concept_name SET concept_name_type = NULL, locale_preferred = 0 WHERE concept_name_id = 51415;
			UPDATE concept_name SET concept_name_type = 'FULLY_SPECIFIED', locale_preferred = 1 WHERE concept_name_id = 107439;
			# 159854 from Supplemental feeding methods to Complementary Feeding
			UPDATE concept_name SET concept_name_type = NULL, locale_preferred = 0 WHERE concept_name_id = 107340;
			UPDATE concept_name SET concept_name_type = 'FULLY_SPECIFIED', locale_preferred = 1 WHERE concept_name_id = 140028;
			# 844 from HIV DNA POLYMERASE CHAIN REACTION to DNA PCR
			UPDATE concept_name SET concept_name_type = NULL, locale_preferred = 0 WHERE concept_name_id = 884;
			UPDATE concept_name SET concept_name_type = 'FULLY_SPECIFIED', locale_preferred = 1 WHERE concept_name_id = 90888;
		</sql>
	</changeSet>
	<changeSet id="concept_mapping_data_migration-06092017-0846" author="ssmusoke">
		<preConditions onFail="CONTINUE">
			<sqlCheck expectedResult="1">SELECT count(concept_id) FROM concept WHERE concept_id = 164931</sqlCheck>
		</preConditions>
		<comment>Migration of data to match new concept mappings</comment>
		<sql>
			# 164401	HIV test performed to 164930 Was a confirmatory test performed on this visit
			# This comes to the top since the concept 164401 on the Infant PNC is to be migrated to HIV test status
			UPDATE obs SET concept_id = 164930 WHERE concept_id = 164401;
			
			# 161558 - Patient tested for sexually transmitted diseases in current visit to 164401 - HIV Test Performed
			
			# Answer migrations
			# Yes - 1065 to 164912
			UPDATE obs SET value_coded = 164912 WHERE value_coded = 1065 AND concept_id = 161558;
			# 1169 - HIV Positive to 164911 Previously known positive
			UPDATE obs SET value_coded = 164911 WHERE value_coded = 1169 AND concept_id = 161558;
			# 1066 - No to 164913 Not tested for HIV during this period
			UPDATE obs SET value_coded = 164913 WHERE value_coded = 1066 AND concept_id = 161558;
			# Migrate the question
			UPDATE obs SET concept_id = 164401 WHERE concept_id = 161558;
			
			# 1396 Mother's HIV Status to 159427 - Result of HIV Test
			# Answer migrations
			# 703 Positive to 138571 - HIV Positive
			UPDATE obs SET value_coded = 138571 WHERE value_coded = 703 AND concept_id = 1396;
			# Migrate the question
			UPDATE obs SET concept_id = 159427 WHERE concept_id = 1396;
			
			# 1662 Are you still on treatement to 164914 Currently on ART
			# Answer migrations
			# 160117 Anti-retroviral treatment status to 164915 ART Initiation Status
			UPDATE obs SET value_coded = 164915 WHERE value_coded = 160117 AND concept_id = 1662;
			# Migrate the question
			UPDATE obs SET concept_id = 164914 WHERE concept_id = 1662;
			
			# 163310 Viral Load Test Done
			# Answer migrations
			# 1267  Completed to 1065 Yes
			UPDATE obs SET value_coded = 1065 WHERE value_coded = 1267 AND concept_id = 163310;
			# 1118  Not Done to 1066 No
			UPDATE obs SET value_coded = 1066 WHERE value_coded = 1118 AND concept_id = 163310;
			
			# 1285 Facility of next appointment to 164916
			# Answer migrations
			# 1066 No to 163266 - Current Health Facility
			UPDATE obs SET value_coded = 163266 WHERE value_coded = 1066 AND concept_id = 1285;
			# 1067 Unknown to 164932 - Missing
			UPDATE obs SET value_coded = 164932 WHERE value_coded = 1067 AND concept_id = 1285;
			# 1065 Yes to 160036 - Patient transferred out
			UPDATE obs SET value_coded = 160036 WHERE value_coded = 1065 AND concept_id = 1285;
			# Migrate the question
			UPDATE obs SET concept_id = 164916 WHERE concept_id = 1285;
			
			# 1856 Mother's status for Maternal Death from 160034 Died to 134612 - Maternal Death
			UPDATE obs SET value_coded = 134612 WHERE value_coded = 160034 AND concept_id = 1856;
			
			# 1148 Infant Received ARV answer 1065 Yes to 164918 ARV Prophylaxis daily up to 6 weeks
			## SEE line 142: UPDATE obs SET value_coded = 164918 WHERE value_coded = 1065 AND concept_id = 1148;
			
			# 5303 HIV Exposure Status to 164921 CHILDS CURRENT HIV STATUS
			# Answer migrations
			# 822 Exposure to HIV to 164920 - Currently Exposed
			UPDATE obs SET value_coded = 164920 WHERE value_coded = 822 AND concept_id = 5303;
			# 1066 No to 164919 - Currently Unexposed
			UPDATE obs SET value_coded = 164919 WHERE value_coded = 1066 AND concept_id = 5303;
			# Migrate the question
			UPDATE obs SET concept_id = 164921 WHERE concept_id = 5303;
			
			# 1148 ARV Prophylaxis Status
			# Answer migrations
			# 1065 Yes to 164922 - Received ARV Prophylaxis
			UPDATE obs SET value_coded = 164922 WHERE value_coded = 1065 AND concept_id = 1148;
			# 1066 No to 164923 - Never Received ARV Prophylaxis
			UPDATE obs SET value_coded = 164923 WHERE value_coded = 1066 AND concept_id = 1148;
			# 160121 ARV discontinued to 164924 - Stopped ARV Prophylaxis according to guideline
			UPDATE obs SET value_coded = 164924 WHERE value_coded = 160121 AND concept_id = 1148;
			
			# 162229 Cotrimoxazole dispensed to 164928 CTX Prophylaxis Status
			# Answer migrations
			# 1065 Yes to 164927 Received CTX Prophylaxis
			UPDATE obs SET value_coded = 164927 WHERE value_coded = 1065 AND concept_id = 162229;
			# 1066 No to 164926 Never Received CTX Prophylaxis
			UPDATE obs SET value_coded = 164926 WHERE value_coded = 1066 AND concept_id = 162229;
			# 160121	ARV discontinued to 164925 Stopped CTX Prophylaxis
			UPDATE obs SET value_coded = 164925 WHERE value_coded = 160121 AND concept_id = 162229;
			# migrate the question
			UPDATE obs SET concept_id = 164928 WHERE concept_id = 162229;

			# 162087 Test name to 164929 Child HIV Test
			UPDATE obs SET concept_id = 164929 WHERE concept_id = 162087;
			
			# 159811	Enrolled in HIV care program to 164931 Linked to ART
			UPDATE obs SET concept_id = 164931 WHERE concept_id = 159811;
		</sql>
	</changeSet>
	<changeSet id="concept_mapping_data_migration-02102017-1503" author="echiteri">
		<preConditions onFail="CONTINUE">
			<sqlCheck expectedResult="1">SELECT count(concept_id) FROM concept WHERE concept_id = 164931</sqlCheck>
		</preConditions>
		<comment>Migration of data to match new concept mappings</comment>
		<sql>
			# Migrate 'unknown' value_coded 1067 to 'missing' value_coded 164932 for all questions excpet for 'HIV test result' 159427
			UPDATE obs SET value_coded = 164932 WHERE concept_id &lt;&gt; 159427 AND value_coded = 1067

		</sql>
	</changeSet>
	<changeSet id="concept_name_changes_from_1.2_review" author="ssmusoke">
		<comment>Updates to concept names to match the literals used on the forms</comment>
		<sql>
			# 160119 from Already on ART to Already on ART before current pregnancy
			UPDATE concept_name SET name = 'Already on ART before current pregnancy' WHERE concept_name_id = '107851';

			# 1754 from Stockout to Not started due to stockout of ART
			UPDATE concept_name SET name = 'Not started due to stockout of ART' WHERE concept_name_id = '2034';

			# 160120 from Taking Inititated ARVs to Started on ART in ANC current pregnancy
			UPDATE concept_name SET name = 'Started on ART in ANC current pregnancy' WHERE concept_name_id = '107853';

			# 134612 from Maternal Death to Mother Died
			UPDATE concept_name SET name = 'Mother Died' WHERE concept_name_id = '34493';

			# 1535 from Female gender to Female
			UPDATE concept_name SET name = 'Female' WHERE concept_name_id = '1795';

			# 1534 from Male gender to Male
			UPDATE concept_name SET name = 'Male' WHERE concept_name_id = '1793';

			# 151849 from Livebirth to Infant Alive
			UPDATE concept_name SET name = 'Infant Alive' WHERE concept_name_id = '107439';

			# 160036 from Patient transferred out to Transfer to Transfer
			UPDATE concept_name SET name = 'Transfer' WHERE concept_name_id = '107695';

			# 163266 from Current health facility to This facility
			UPDATE concept_name SET name = 'This facility' WHERE concept_name_id = '135553';

			# 1595 from REPLACEMENT FEEDING to Replacement feeding
			UPDATE concept_name SET name = 'Replacement feeding' WHERE concept_name_id = '1872';
		</sql>
	</changeSet>
	<changeSet id="migrate_164915_to_164915" author="echiteri">
		<comment> Concept 164915 for ART initiation wasn't migrated at all during concept remapping and migration. The query below migrates it</comment>
		<sql>
			# Correctly migrate concept 160117 to 164915
			UPDATE obs SET concept_id = 164915 WHERE concept_id = 160117
		</sql>
	</changeSet>
	<changeSet id="manage_open_visits" author="echiteri">
		<comment> Create visits to move encounters clustered in one open visit. Then close open visits </comment>
		<sql>
			# Create new visits for encounters where the encounter date is not equal to the visit date {906 rows affected with the insert }
			INSERT INTO visit ( patient_id, visit_type_id, date_started, date_stopped, location_id, creator, date_created, voided, uuid ) SELECT
			e.patient_id,
			1,
			concat( date( encounter_datetime ), ' 00:00:00' ),
			concat( date( e.encounter_datetime ), ' 23:59:59' ),
			e.location_id,
			e.creator,
			e.date_created,
			0,
			UUID( )
			FROM
			encounter e
			INNER JOIN visit v ON e.patient_id = v.patient_id
			AND e.visit_id = v.visit_id
			AND TO_DAYS(e.encounter_datetime) != TO_DAYS(v.date_started)
			AND e.voided = FALSE
			AND v.voided = FALSE
		</sql>
		<sql>

			# Move the encounters whose encounter dates do not match the visit dates, these are the encounters created in unclosed {906 rows affected with the update }
			UPDATE encounter,
			visit
			SET encounter.visit_id = visit.visit_id
			WHERE
			encounter.patient_id = visit.patient_id
			AND TO_DAYS(encounter_datetime) = TO_DAYS(date_started)
			AND encounter.visit_id != visit.visit_id
			AND encounter.voided = FALSE
			AND visit.voided = FALSE
		</sql>
		<sql>

			# Set all visits to end on the same day they started {2200 rows affected with the update }
			UPDATE visit
			SET date_stopped = concat( date( date_started ), ' 23:59:59' )
			WHERE
			date_stopped IS NULL
			AND voided = 0;
		</sql>
		<sql>
			# Delete unattached visits after the migration of encounters to visits
			DELETE FROM visit WHERE visit_id NOT IN (SELECT visit_id FROM encounter)
		</sql>
	</changeSet>
<changeSet id="correct_errorneously_selected_facilities" author="echiteri">
		<comment>Users wrongly picked facility which are similar in names while logging in hence assigning patients to wrong facilities.
			The statements below update these facilities to correct ones. </comment>
		<sql>
			# Update client registered to facilities "Mpungu Health Centre" to "Mupini Health Centre"
			UPDATE patient_identifier SET location_id = 183 WHERE location_id = 146
		</sql>
		<sql>
			# Update client registered to facilities  "Otjondjeka"to "Otjomuise"
			UPDATE patient_identifier SET location_id = 207 WHERE location_id = 245
		</sql>
	</changeSet>

	<changeSet id="create_task_to_autocreate_ptracker_id_for_new_pregnancies" author="echiteri">
		<preConditions onFail="MARK_RAN">
			<sqlCheck expectedResult="0">
				SELECT COUNT(*) FROM scheduler_task_config
				WHERE schedulable_class = 'org.openmrs.module.namibia.tasks.AutoCreateNewPTrackerID'
			</sqlCheck>
		</preConditions>
		<comment>Inserting Auto Create New PTracker ID Task into 'schedule_task_config' table</comment>
		<insert tableName="scheduler_task_config">
			<column name="name" value="Auto Create New PTracker ID" />
			<column name="description" value="Auto Create New PTracker ID for new pregnancies using PTracker ID on obs Table" />
			<column name="schedulable_class" value="org.openmrs.module.namibia.tasks.AutoCreateNewPTrackerID" />
			<column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
			<column name="start_time" valueDate="2018-10-23T11:59:59" />
			<column name="repeat_interval" value="86400" />
			<column name="date_created" valueDate="CURRENT_TIMESTAMP" />
			<column name="created_by" value="3" />
			<column name="start_on_startup" value="1"/>
			<column name="started" value="1"/>
			<column name="uuid" value="29584cdf-37c0-46ec-b942-3b98274e30d8" />
		</insert>

	</changeSet>

	<changeSet id="copy_ptracker_id_from_obs_to_patient_identifier_table" author="echiteri">
		<comment>Copy PTracker ID created on the encounter form and create  the new PTrackerID as an identifier </comment>
		<sql>
			# Drop the pivotal table mds_new_ptracker_id
			DROP TABLE IF EXISTS mds_new_ptracker_id;

			# Create new ptracker id table to store new ptracker ids captured in the encounter forms
			CREATE TABLE mds_new_ptracker_id AS
				SELECT
					e.patient_id,
					MAX( IF ( o.concept_id = 164951, o.value_text, NULL ) ) AS identifier,
					7 AS identifier_type,
					0 AS preferred,
					NULL AS location_id,
					1 AS creator,
					CURRENT_DATE() AS date_created,
					0 AS voided, UUID() AS uuid
				FROM
					encounter e
					INNER JOIN obs o ON e.encounter_id = o.encounter_id
					AND o.voided =0 #  They are not voided
					AND o.concept_id = 164951 #  PTracker ID concept
					AND o.value_text NOT IN (SELECT identifier FROM patient_identifier) # The PTracker ID doesn't exist
					AND o.value_text REGEXP '^[0-9]{5}[A-S]{1}[0-9]{6}$' #  Only Migrate ID's that meet the PTracker ID format
					LEFT OUTER JOIN patient_identifier pi ON e.patient_id = pi.patient_id
					INNER JOIN person p ON e.patient_id = p.person_id
					GROUP BY
					o.value_text #  Get DISTINCT PTracker ID;

			# Copy the patient identifier table
			INSERT  INTO patient_identifier (patient_id, identifier, identifier_type, preferred, location_id, creator, date_created, voided, uuid)
			SELECT * from mds_new_ptracker_id;

			# Drop the pivotal table mds_new_ptracker_id
			DROP TABLE IF EXISTS mds_new_ptracker_id;
		</sql>
	</changeSet>
</databaseChangeLog>